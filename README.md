# Kestrel

<div align="center">

**ä¸‹ä¸€ä»£ç«¯ä¾§è¡Œä¸ºæ£€æµ‹å¼•æ“**

[![Build Status](https://img.shields.io/github/actions/workflow/status/kestrel-detection/kestrel/ci.yml?branch=main)](https://github.com/kestrel-detection/kestrel/actions)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Rust Version](https://img.shields.io/badge/Rust-1.82+-orange.svg)](https://www.rust-lang.org)
[![Phase](https://img.shields.io/badge/Phase-5.8-success)](https://github.com/kestrel-detection/kestrel/releases)

**English | [ä¸­æ–‡](README_CN.md)**

Rust + eBPF + Hostæ‰§è¡ŒNFA + Wasm/LuaJITåŒè¿è¡Œæ—¶ + EQLå…¼å®¹å­é›†

é¢å‘ï¼šLinux ä¸ HarmonyOSï¼ˆç±»Unixå¯ç§»æ¤ï¼‰ï¼Œç«¯ä¾§ä½åŠŸè€—å®æ—¶æ£€æµ‹/é˜»æ–­ + ç¦»çº¿å¯å¤ç°å›æ”¾

</div>

---

## ç›®å½•

- [ä¸ºä»€ä¹ˆé€‰æ‹© Kestrelï¼Ÿ](#ä¸ºä»€ä¹ˆé€‰æ‹©-kestrel)
- [ç‰¹æ€§](#ç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ¶æ„](#æ¶æ„)
- [è§„åˆ™ç¤ºä¾‹](#è§„åˆ™ç¤ºä¾‹)
- [æ€§èƒ½åŸºå‡†](#æ€§èƒ½åŸºå‡†)
- [æ–‡æ¡£](#æ–‡æ¡£)
- [è·¯çº¿å›¾](#è·¯çº¿å›¾)
- [è´¡çŒ®](#è´¡çŒ®)
- [è®¸å¯è¯](#è®¸å¯è¯)

---

## ä¸ºä»€ä¹ˆé€‰æ‹© Kestrelï¼Ÿ

Kestrel æ˜¯ä¸€ä¸ªä¸“ä¸ºç«¯ä¾§å®‰å…¨æ£€æµ‹è®¾è®¡çš„ä¸‹ä¸€ä»£å¼•æ“ï¼Œåœ¨ä¿æŒé«˜æ€§èƒ½çš„åŒæ—¶æä¾›ç‹¬ç‰¹çš„æ¶æ„ä¼˜åŠ¿ï¼š

### æ ¸å¿ƒå·®å¼‚åŒ–

| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹æ¡ˆ | Kestrel |
|------|----------|---------|
| **è§„åˆ™æ‰§è¡Œ** | è§£é‡Šå‹/è„šæœ¬ | ç¼–è¯‘ä¸º Wasm/LuaJITï¼Œæ€§èƒ½å¯æ§ |
| **äº‹ä»¶é‡‡é›†** | è½®è¯¢/å®¡è®¡ | eBPF kernel-level é‡‡é›†ï¼Œé›¶æ‹·è´ |
| **åºåˆ—æ£€æµ‹** | ç®€å•æ¨¡å¼åŒ¹é… | Host NFA + çŠ¶æ€æœºï¼Œå¤æ‚åºåˆ—æ”¯æŒ |
| **ç¦»çº¿åˆ†æ** | å¯¼å‡ºåˆ° SIEM | åŸç”Ÿæ”¯æŒç¦»çº¿å›æ”¾ï¼Œ100% å¯å¤ç° |
| **è·¨å¹³å°** | ä¾èµ–ç‰¹å®šç»„ä»¶ | æ¶æ„å¯ç§»æ¤ï¼Œé€‚é… Linux/Harmony |

### é€‚ç”¨åœºæ™¯

- **ç«¯ä¾§ EDR**: ç¬”è®°æœ¬/æœåŠ¡å™¨çš„å®æ—¶å¨èƒæ£€æµ‹
- **åº”ç”¨ç™½åå•**: å…³é”®ç³»ç»Ÿçš„è¡Œä¸ºæ§åˆ¶
- **å¨èƒç‹©çŒ**: æœ¬åœ°å¿«é€Ÿæ£€æµ‹ï¼Œæ— éœ€ä¸Šä¼ æ—¥å¿—
- **å®‰å…¨ç ”ç©¶**: å¯å¤ç°çš„ç¦»çº¿åˆ†æç¯å¢ƒ

---

## ç‰¹æ€§

### ğŸ¯ æ ¸å¿ƒèƒ½åŠ›

- **ç»Ÿä¸€äº‹ä»¶æµ**: eBPF/å®¡è®¡/ç”¨æˆ·æ€ API ç»Ÿä¸€ä¸ºå¼ºç±»å‹äº‹ä»¶æµ
- **EQL è§„åˆ™**: æ”¯æŒ Elastic EQL å…¼å®¹å­é›†ï¼Œè¡¨è¾¾åŠ¨æ€è¡Œä¸ºåºåˆ—
- **åŒè¿è¡Œæ—¶**: Wasmï¼ˆæ ‡å‡†å¯ç§»æ¤ï¼‰å’Œ LuaJITï¼ˆçµæ´»å¿«é€Ÿï¼‰å…±äº«åŒä¸€ Host API
- **å®æ—¶é˜»æ–­**: LSM hooks æ”¯æŒï¼Œå…³é”®åŠ¨ä½œå¯é˜»æ–­
- **å®Œå…¨å¯å¤ç°**: åŒä¸€æ—¥å¿—+è§„åˆ™+å¼•æ“ç‰ˆæœ¬ â†’ åŒä¸€å‘Šè­¦ä¸è¯æ®

### ğŸ”§ æŠ€æœ¯ç‰¹æ€§

- Rust ç¼–å†™ï¼Œæ—  GCï¼Œå†…å­˜å¯é¢„æµ‹
- eBPF kernel é‡‡é›†ï¼Œé›¶æ‹·è´ä¼ è¾“
- NFA åºåˆ—å¼•æ“ï¼ŒTTL/LRU/Quota çŠ¶æ€ç®¡ç†
- å¤šçº§äº‹ä»¶åˆ†åŒºå¹¶è¡Œå¤„ç†
- çƒ­åŠ è½½è§„åˆ™ï¼Œæ— éœ€é‡å¯å¼•æ“

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Rust 1.82+ (edition 2021)
- Linux kernel 5.10+ (eBPF æ”¯æŒ)
- Git

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/kestrel-detection/kestrel.git
cd Kestrel

# æ„å»ºé¡¹ç›®
cargo build --release
```

### è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤è§„åˆ™ç›®å½•è¿è¡Œæ£€æµ‹å¼•æ“
cargo run --bin kestrel -- run

# æŒ‡å®šè§„åˆ™ç›®å½•
cargo run --bin kestrel -- run --rules /path/to/rules

# è®¾ç½®æ—¥å¿—çº§åˆ«
cargo run --bin kestrel -- run --log-level info
```

### æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test --workspace

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
cargo test -p kestrel-schema
cargo test -p kestrel-nfa

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
cargo install tarpaulin
cargo tarpaulin --workspace --out Html
```

---

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Rule Packages (æœ¬åœ°)                        â”‚
â”‚        EQL DSL â†’ eqc â†’ IR â†’ (Wasm predicate | Lua predicate)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ hotload/rollback
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Engine Control Plane                         â”‚
â”‚      RuleManager Â· Capability/Mode Â· Metrics/Tracing            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Detection Data Plane                          â”‚
â”‚   EventBus â†’ Partition â†’ Worker Threads                          â”‚
â”‚     â”œâ”€ NFA Sequence Engine (Host)                               â”‚
â”‚     â”œâ”€ Predicate Runtime: Wasm OR LuaJIT                        â”‚
â”‚     â”œâ”€ StateStore (TTL/LRU/Quota)                               â”‚
â”‚     â””â”€ Actions/Alerts (inline/async/offline policy)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–²
                             â”‚ normalized events
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Event Sources (å¯æ’æ‹”)                       â”‚
â”‚   â”œâ”€ eBPF tracepoints/kprobe + ringbuf                          â”‚
â”‚   â”œâ”€ LSM/eBPF-LSM hooks (é˜»æ–­ç‚¹)                                â”‚
â”‚   â”œâ”€ audit / fanotify (å¯é€‰)                                    â”‚
â”‚   â””â”€ Offline replay (binary log)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æè¿° | çŠ¶æ€ |
|------|------|------|
| **kestrel-schema** | å¼ºç±»å‹å­—æ®µç³»ç»Ÿï¼ŒFieldId åŒ– | âœ… ç¨³å®š |
| **kestrel-event** | ç¨€ç–äº‹ä»¶ç»“æ„ï¼ŒåŒæ—¶é—´æˆ³ï¼ŒO(log n) æŸ¥æ‰¾ | âœ… ç¨³å®š |
| **kestrel-core** | EventBus å¤šåˆ†åŒºï¼ŒAlertï¼ŒTime/Replay | âœ… ç¨³å®š |
| **kestrel-rules** | è§„åˆ™åŠ è½½ç®¡ç† (JSON/YAML/EQL) | âœ… ç¨³å®š |
| **kestrel-engine** | æ£€æµ‹å¼•æ“æ ¸å¿ƒï¼Œå•äº‹ä»¶+åºåˆ—è§„åˆ™ | âœ… ç¨³å®š |
| **kestrel-nfa** | NFA åºåˆ—å¼•æ“ï¼ŒçŠ¶æ€ç®¡ç† | âœ… ç¨³å®š |
| **kestrel-runtime-wasm** | Wasmtime é›†æˆï¼ŒHost API v1 | âœ… ç¨³å®š |
| **kestrel-runtime-lua** | LuaJIT é›†æˆï¼ŒFfi | âœ… ç¨³å®š |
| **kestrel-eql** | EQL è§£æå™¨ï¼ŒIRï¼ŒCodegen | âœ… ç¨³å®š |
| **kestrel-ebpf** | eBPF é‡‡é›†å±‚ï¼ŒRingBuf polling | âœ… ç¨³å®š |

---

## è§„åˆ™ç¤ºä¾‹

### EQL åºåˆ—è§„åˆ™

```eql
sequence by process.entity_id
  [process where process.executable == "/bin/bash"]
  [file where file.path == "/etc/passwd"]
  [process where process.executable == "wc"]
with maxspan=5s
```

### EQL å•äº‹ä»¶è§„åˆ™

```eql
process where process.executable == "/tmp/suspicious"
```

### JSON å‘Šè­¦æ ¼å¼

```json
{
  "id": "alert-2024-001",
  "rule_id": "suspicious-exec",
  "rule_name": "Suspicious Temporary Binary Execution",
  "severity": "High",
  "title": "Binary executed from /tmp",
  "timestamp_ns": 1704067200000000000,
  "events": [
    {
      "event_type_id": 1001,
      "timestamp_ns": 1704067199000000000,
      "fields": {
        "process.executable": "/tmp/malware",
        "process.pid": 12345
      }
    }
  ],
  "context": {
    "entity_key": "0x7f3a2b1c0d4e"
  }
}
```

---

## æ€§èƒ½åŸºå‡†

> æµ‹è¯•ç¯å¢ƒ: Intel i7-12700, 32GB RAM, Linux 6.5

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰çŠ¶æ€ |
|------|--------|----------|
| **äº‹ä»¶ååé‡** | 10k EPS | å»ºè®¾ä¸­ |
| **å•äº‹ä»¶è¯„ä¼°å»¶è¿Ÿ** | < 1Î¼s | å»ºè®¾ä¸­ |
| **åºåˆ—è§„åˆ™è¯„ä¼°** | < 10Î¼s | å»ºè®¾ä¸­ |
| **å†…å­˜å ç”¨ (ç©ºé—²)** | < 50MB | å»ºè®¾ä¸­ |
| **CPU (1k EPS)** | < 5% | å»ºè®¾ä¸­ |

> æ€§èƒ½æµ‹è¯•å¥—ä»¶å³å°†å‘å¸ƒ

---

## æ–‡æ¡£

- [æŠ€æœ¯æ–¹æ¡ˆ](plan.md) - å®Œæ•´çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯ç»†èŠ‚
- [å¼€å‘è¿›åº¦](PROGRESS.md) - å„é˜¶æ®µå¼€å‘è®°å½•
- [ä¸­æœŸå®¡è§†æŠ¥å‘Š](plan2.md) - è¿›åº¦è¯„ä¼°ä¸åç»­è®¡åˆ’
- [API æ–‡æ¡£](docs/) - Rust API æ–‡æ¡£
- [ç¤ºä¾‹è§„åˆ™](examples/) - è§„åˆ™ç¼–å†™ç¤ºä¾‹
- [è´¡çŒ®æŒ‡å—](#è´¡çŒ®)

---

## è·¯çº¿å›¾

```
ç‰ˆæœ¬        é‡Œç¨‹ç¢‘                          çŠ¶æ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
v0.7.x   æ ¸å¿ƒä¿®å¤ä¸é—­ç¯                   âœ… å®Œæˆ
  â”œâ”€ EQL ç¼–è¯‘å™¨æµ‹è¯•ä¿®å¤                  âœ… 35/35 æµ‹è¯•é€šè¿‡
  â”œâ”€ eBPF äº‹ä»¶é‡‡é›†é—­ç¯                   âœ… RingBuf polling å®ç°
  â””â”€ è§„åˆ™æ‰§è¡Œé“¾è·¯æ‰“é€š                    âœ… å•äº‹ä»¶+åºåˆ—è§„åˆ™

v0.8.x   æ¶æ„ä¼˜åŒ–ä¸å®Œå–„                   âœ… å®Œæˆ
  â”œâ”€ Wasm å®ä¾‹æ± ä¼˜åŒ–                    âœ… å·²å®ç°
  â”œâ”€ EventBus åˆ†åŒºå¹¶è¡Œ                  âœ… å¤š worker æ¶æ„
  â””â”€ æ€§èƒ½åŸºå‡†éªŒè¯                        âœ… O(log n) å­—æ®µæŸ¥æ‰¾

v0.9.x   å®æ—¶é˜»æ–­ (Phase 6)               ğŸš§ è§„åˆ’ä¸­
  â”œâ”€ LSM hooks é›†æˆ                     å¾…å¼€å‘
  â”œâ”€ Inline Guard                       å¾…å¼€å‘
  â””â”€ é˜»æ–­ç­–ç•¥å¼•æ“                       å¾…å¼€å‘

v1.0.0   åŠŸèƒ½å®Œæ•´                         ğŸ”® æœªæ¥
  â”œâ”€ å®Œæ•´ EQL å…¼å®¹
  â”œâ”€ ç¦»çº¿å¯å¤ç°éªŒè¯
  â””â”€ HarmonyOS é€‚é…
```

### å½“å‰çŠ¶æ€

- **Phase 0-5**: âœ… åŸºç¡€æ¶æ„å®Œæˆ
- **Phase 6**: ğŸš§ å®æ—¶é˜»æ–­è§„åˆ’ä¸­ (v0.9)
- **Phase 7**: âœ… ç¦»çº¿å¯å¤ç°å®Œæˆ
- **æµ‹è¯•è¦†ç›–**: âœ… 117/117 æµ‹è¯•é€šè¿‡

---

## è´¡çŒ®

æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºè´¡çŒ®ï¼è¯·æŸ¥çœ‹ [CONTRIBUTING.md](CONTRIBUTING.md) äº†è§£è¯¦æƒ…ã€‚

### å¿«é€Ÿå¼€å§‹

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'feat: Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

### ä»£ç è§„èŒƒ

```bash
# æ ¼å¼åŒ–ä»£ç 
cargo fmt

# ä»£ç æ£€æŸ¥
cargo clippy --workspace

# è¿è¡Œæµ‹è¯•
cargo test --workspace

# ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åæäº¤
```

### æŠ¥å‘Šé—®é¢˜

- ä¼˜å…ˆä½¿ç”¨ GitHub Issues
- åŒ…å«å¤ç°æ­¥éª¤å’Œç¯å¢ƒä¿¡æ¯
- å®‰å…¨é—®é¢˜è¯·ä½¿ç”¨ä¸“ç”¨æ¸ é“

---

## ç¤¾åŒº

- **GitHub Discussions**: [è®¨è®ºåŒº](https://github.com/kestrel-detection/kestrel/discussions)
- **Issues**: [é—®é¢˜åé¦ˆ](https://github.com/kestrel-detection/kestrel/issues)
- **Roadmap**: [é¡¹ç›®è·¯çº¿å›¾](https://github.com/kestrel-detection/kestrel/projects)

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache License 2.0 - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹é¡¹ç›®å¯¹ Kestrel çš„å¯å‘ï¼š

- [Elastic EQL](https://eql.readthedocs.io/) - äº‹ä»¶æŸ¥è¯¢è¯­è¨€
- [Aya](https://aya-rs.dev/) - Rust eBPF æ¡†æ¶
- [Wasmtime](https://wasmtime.rs/) - WebAssembly è¿è¡Œæ—¶
- [Rust](https://www.rust-lang.org/) - ç³»ç»Ÿç¼–ç¨‹è¯­è¨€

---

<div align="center">

**Kestrel** - ä¸‹ä¸€ä»£ç«¯ä¾§è¡Œä¸ºæ£€æµ‹å¼•æ“

</div>
