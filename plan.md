# ä¸‹ä¸€ä»£ç«¯ä¾§è¡Œä¸ºæ£€æµ‹å¼•æ“ç™½çš®ä¹¦ä¸æ¶æ„æŠ€æœ¯æ–¹æ¡ˆï¼ˆKestrelï¼‰
**Rust + eBPF +ï¼ˆHost æ‰§è¡Œ NFAï¼‰+ Wasm/LuaJIT åŒè¿è¡Œæ—¶ + EQL å…¼å®¹å­é›†**  
é¢å‘ï¼šLinux ä¸ Harmonyï¼ˆç±» Unix å¯ç§»æ¤ï¼‰ï¼Œç«¯ä¾§ä½åŠŸè€—å®æ—¶æ£€æµ‹/é˜»æ–­ + ç¦»çº¿å¯å¤ç°å›æ”¾

---

## 0. æ‰§è¡Œæ‘˜è¦ï¼ˆWhat & Whyï¼‰
æˆ‘ä»¬å»ºè®¾çš„æ˜¯ä¸€å¥—ç«¯ä¾§é«˜æ€§èƒ½è¡Œä¸ºæ£€æµ‹å¼•æ“ï¼Œåä¸ºKestrel, 
æ ¸å¿ƒå·®å¼‚åŒ–åœ¨äºï¼š

1. **ç»Ÿä¸€äº‹ä»¶æµä¸å¯æ’æ‹”é‡‡é›†å±‚**ï¼šeBPF/å®¡è®¡/ç”¨æˆ·æ€ API ç»Ÿä¸€ä¸ºå¼ºç±»å‹äº‹ä»¶æµï¼›å¯æŒ‰è§„åˆ™â€œå…´è¶£â€ä¸‹æ¨è¿‡æ»¤ï¼Œå‡å°‘ç«¯ä¾§åŠŸè€—ã€‚
2. **EQL è§„åˆ™ä½“ç³» + åºåˆ—å¼•æ“ï¼ˆHost NFAï¼‰**ï¼šç”¨ä¸šå†…æˆç†Ÿçš„ EQL è¡¨è¾¾â€œåŠ¨æ€è¡Œä¸ºåºåˆ—â€ï¼›ç”±å®¿ä¸»æ‰§è¡Œ NFA/çª—å£/å…³è”ï¼›è°“è¯æ‰§è¡Œäº¤ç»™ Wasm/LuaJITã€‚
3. **åŒè¿è¡Œæ—¶ç»Ÿä¸€ Host API**ï¼šè§„åˆ™å¯ä»¥ç¼–è¯‘æˆ Wasmï¼ˆæ ‡å‡†ã€å¯ç§»æ¤ï¼‰æˆ– LuaJITï¼ˆçµæ´»ã€å¿«é€Ÿè¿­ä»£ã€ç«¯ä¾§æ€§èƒ½å¥½ï¼‰ï¼›äºŒè€…å…±äº«åŒä¸€å¥— Host API ä¸ IR æ¥å£ã€‚
4. **å®æ—¶é˜»æ–­ä¸ç¦»çº¿å¯å¤ç°**ï¼šåŒä¸€è§„åˆ™ã€åŒä¸€æ£€æµ‹æ ¸åœ¨ inlineï¼ˆé˜»æ–­ï¼‰ä¸ async/offlineï¼ˆåˆ†æå›æ”¾ï¼‰æ¨¡å¼ä¸‹è¿è¡Œï¼Œä¿è¯ç»“æœå¯è§£é‡Šã€å¯å¤ç°ã€‚

---

## 0.1 é¡¹ç›®è¿›å±•æ€»è§ˆï¼ˆ2026å¹´1æœˆï¼‰

### å½“å‰ç‰ˆæœ¬çŠ¶æ€
- **ç‰ˆæœ¬å·**: v0.2.0
- **æ ¸å¿ƒçŠ¶æ€**: å¼•æ“åŸºç¡€æ¡†æ¶å®Œæˆï¼Œè¿›å…¥ç”Ÿäº§åŒ–å‡†å¤‡é˜¶æ®µ
- **ä»£ç è´¨é‡**: 28+ æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œæ— å·²çŸ¥é˜»å¡é—®é¢˜

### å·²å®Œæˆæ¨¡å—ï¼ˆæŒ‰æ¶æ„å±‚æ¬¡ï¼‰

#### âœ… æ ¸å¿ƒå¼•æ“å±‚
- **Schema Registry**: å¼ºç±»å‹äº‹ä»¶å­—æ®µæ³¨å†Œç³»ç»Ÿï¼Œæ”¯æŒ field_id åŒ–
- **EventBus**: äº‹ä»¶æ€»çº¿ï¼Œæ”¯æŒæ‰¹å¤„ç†ã€èƒŒå‹æ§åˆ¶ã€metrics æ”¶é›†
- **NFA Engine**: éç¡®å®šæœ‰é™è‡ªåŠ¨æœºåºåˆ—å¼•æ“ï¼Œæ”¯æŒå¤šè§„åˆ™å¹¶è¡ŒåŒ¹é…
- **StateStore**: TTL/LRU/Quota ä¸‰é‡æ·˜æ±°æœºåˆ¶ï¼Œæ”¯æŒ per-rule/per-entity é¢„ç®—
- **Metrics**: ç»Ÿä¸€æŒ‡æ ‡æ”¶é›†ç³»ç»Ÿï¼ˆEngineMetrics + UnifiedMetricsï¼‰ï¼Œæ”¯æŒ Prometheus/JSON å¯¼å‡º

#### âœ… åŒè¿è¡Œæ—¶ç³»ç»Ÿ
- **Wasm Runtime**: åŸºäº Wasmtimeï¼Œå®ç° Host API v1ï¼Œæ”¯æŒ instance pool å¤ç”¨
- **Lua Runtime**: åŸºäº MLua (LuaJIT)ï¼Œå®ç° Host API v1ï¼Œä¸ Wasm å…±äº« ABI
- **PredicateEvaluator**: ç»Ÿä¸€è°“è¯è¯„ä¼°æ¥å£ï¼Œè¿è¡Œæ—¶å¯æ’æ‹”
- **PoolMetrics**: Wasm instance pool æŒ‡æ ‡ï¼ˆåˆ©ç”¨ç‡ã€ç­‰å¾…æ—¶é—´ã€ç¼“å­˜å‘½ä¸­ç‡ï¼‰

#### âœ… è§„åˆ™åŠ è½½ç³»ç»Ÿ
- **RuleManager**: è§„åˆ™åŒ…çƒ­åŠ è½½ã€ç‰ˆæœ¬ç®¡ç†ã€åŸå­åˆ‡æ¢
- **RulePackage**: EQL ç¼–è¯‘äº§ç‰©æ‰“åŒ…ï¼ˆmetadata + predicates + capabilitiesï¼‰
- **åŠ è½½éš”ç¦»**: load_semaphore ä¿æŠ¤ï¼Œé¿å…å¹¶å‘åŠ è½½å†²çª

#### âœ… ç¦»çº¿å¯å¤ç°ï¼ˆReplayï¼‰
- **BinaryLog**: äº‹ä»¶äºŒè¿›åˆ¶æ—¥å¿—ï¼Œç´§å‡‘åºåˆ—åŒ–
- **ReplayEngine**: åŒæ ¸å›æ”¾ï¼Œä¿è¯ç»“æœå¯å¤ç°
- **å¯å¤ç°å¥‘çº¦**:
  - `event_id`: ç”¨äºäº‹ä»¶æ’åº tie-breaker
  - `rule_pack_hash`: è§„åˆ™åŒ…ç‰ˆæœ¬å“ˆå¸Œ
  - `ts_mono_ns + event_id`: ç¡®å®šæ€§æ’åºé”®

#### âœ… é‡‡é›†å±‚ï¼ˆeBPFï¼‰
- **Normalization**: äº‹ä»¶è§„èŒƒåŒ–ï¼Œå¼ºç±»å‹å­—æ®µæ˜ å°„
- **InterestPushdown**: æŒ‰"è§„åˆ™å…´è¶£"è¿‡æ»¤ï¼Œå‡å°‘æ— ç”¨æ•°æ®æ”¶é›†
- **æ¡†æ¶å®Œæ•´**: tracepoints/kprobes/LSM hooks æ¶æ„å°±ç»ª

#### âœ… C FFI å…¼å®¹æ¥å£
- **kestrel-ffi**: C API å±‚ï¼Œå®Œæ•´å¯¼å‡ºå¼•æ“ç”Ÿå‘½å‘¨æœŸã€è§„åˆ™ç®¡ç†ã€äº‹ä»¶å¤„ç†ã€æŒ‡æ ‡æŸ¥è¯¢
- **ABI ç¨³å®š**: C å¤´æ–‡ä»¶ï¼ˆkestrel.hï¼‰å®šä¹‰å®Œæ•´çš„ opaque handle ç±»å‹
- **ç¤ºä¾‹ç¨‹åº**: simple.c / advanced.c å±•ç¤º API ç”¨æ³•
- **å…±äº«åº“**: libkestrel_ffi.so (342K)ï¼Œæ”¯æŒ Linux glibc 2.17+

### è¿‘æœŸå®Œæˆï¼ˆ2026å¹´1æœˆ13æ—¥ï¼‰

#### Phase A: eBPF é›†æˆæµ‹è¯•ä¸æ€§èƒ½åŸºçº¿ âœ…
- åˆ›å»ºé›†æˆæµ‹è¯•å¥—ä»¶ï¼ˆ10ä¸ªæµ‹è¯•ï¼Œè¦†ç›– normalize/pushdown/end-to-endï¼‰
- åˆ›å»ºæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆ12ä¸ªæµ‹è¯•ï¼Œå»ºç«‹æ€§èƒ½åŸºçº¿ï¼‰
- å¯¼å‡º InterestPushdown API
- **æ–‡ä»¶**: kestrel-ebpf/tests/integration_test.rs, performance_benchmark.rs

#### Phase B: C FFI å…¼å®¹æ¥å£ âœ…
- **B.1**: åŸºç¡€æ¡†æ¶å®Œæˆï¼ˆEngine API, ç±»å‹å®šä¹‰, é”™è¯¯å¤„ç†ï¼‰
- **B.2**: äº‹ä»¶å¤„ç† API å®Œæˆï¼ˆprocess_event, alerts, metricsï¼‰
- 11ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- C ç¤ºä¾‹ç¨‹åºè¿è¡ŒæˆåŠŸ
- **æ–‡ä»¶**: kestrel-ffi crate, examples/simple.c, examples/advanced.c

#### Phase C: å¯è§‚æµ‹æ€§å®Œå–„ âœ…
- **C.1**: Wasm pool æŒ‡æ ‡æ”¶é›† âœ…
  - PoolMetrics ç»“æ„ï¼ˆpool_size, active_instances, acquires, releases, missesï¼‰
  - ç­‰å¾…æ—¶é—´è·Ÿè¸ªï¼ˆtotal_wait_ns, peak_wait_ns, avg_wait_nsï¼‰
  - åˆ©ç”¨ç‡ä¸ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—
- **C.2**: æ€§èƒ½åŸºçº¿æµ‹è¯• âœ…
  - ä¿®å¤æ€§èƒ½åŸºå‡†æµ‹è¯•é˜ˆå€¼é—®é¢˜ï¼ˆvector growth benchmarkï¼‰
  - 12ä¸ªeBPFæ€§èƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡
  - å»ºç«‹æ€§èƒ½åŸºçº¿ï¼ˆnormalize, pushdown, memory, scalabilityï¼‰

#### Phase D.1: Aho-Corasickå¤šæ¨¡DFA âœ…
- **åˆ›å»º kestrel-ac-dfa crate**ï¼ˆ~3000è¡Œä»£ç ï¼‰
  - æ ¸å¿ƒæ¨¡å—ï¼šbuilder, matcher, pattern
  - Aho-Corasickè‡ªåŠ¨æœºå®ç°ï¼ˆåŸºäºaho-corasick crateï¼‰
  - æ”¯æŒ4ç§åŒ¹é…æ¨¡å¼ï¼šEquals, Contains, StartsWith, EndsWith
  - PatternExtractorä»EQL IRè‡ªåŠ¨æå–å­—ç¬¦ä¸²å­—é¢é‡
- **æµ‹è¯•è¦†ç›–**ï¼š19ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- **é›†æˆ**ï¼šå·²åŠ å…¥workspaceï¼Œä¸kestrel-eql IRé›†æˆ
- **ä»£ç è´¨é‡**ï¼š0ç¼–è¯‘è­¦å‘Š
- **æ€§èƒ½é¢„æœŸ**ï¼šå­—ç¬¦ä¸²å­—é¢é‡è§„åˆ™ 5-10xåŠ é€Ÿï¼ˆå¾…å®é™…æµ‹è¯•éªŒè¯ï¼‰
- **æ–‡ä»¶**:
  - kestrel-ac-dfa/src/lib.rs (æ ¸å¿ƒç±»å‹å®šä¹‰)
  - kestrel-ac-dfa/src/builder.rs (PatternExtractor + AcDfaBuilder)
  - kestrel-ac-dfa/src/matcher.rs (AcMatcher + StringMatch)
  - kestrel-ac-dfa/src/pattern.rs (MatchPattern + PatternKind)

#### Phase D.2: æƒ°æ€§DFAç¼“å­˜ç³»ç»Ÿ âœ…
- **åˆ›å»º kestrel-lazy-dfa crate**ï¼ˆ~2500è¡Œä»£ç ï¼‰
  - æ ¸å¿ƒæ¨¡å—ï¼šcache, converter, detector, dfa
  - âœ… çƒ­åº¦æ£€æµ‹é€»è¾‘ï¼ˆHotSpotDetectorï¼‰- è·Ÿè¸ªåºåˆ—åŒ¹é…é¢‘ç‡å’ŒæˆåŠŸç‡
  - âœ… NFAâ†’DFAè½¬æ¢ç®—æ³•ï¼ˆNfaToDfaConverterï¼‰- Subset constructionå®ç°
  - âœ… LRUç¼“å­˜ç®¡ç†ï¼ˆDfaCacheï¼‰- å†…å­˜é™åˆ¶å’Œè‡ªåŠ¨æ·˜æ±°
- **æµ‹è¯•è¦†ç›–**ï¼š30ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆ23å•å…ƒ+7é›†æˆï¼‰
  - âœ… å•å…ƒæµ‹è¯•ï¼šçƒ­åº¦æ£€æµ‹ã€DFAè½¬æ¢ã€ç¼“å­˜ç®¡ç†
  - âœ… é›†æˆæµ‹è¯•ï¼šå®Œæ•´å·¥ä½œæµç¨‹ï¼ˆæ£€æµ‹â†’è½¬æ¢â†’ç¼“å­˜ï¼‰
  - âœ… è¾¹ç•Œæµ‹è¯•ï¼šå†…å­˜é™åˆ¶ã€çŠ¶æ€é™åˆ¶ã€LRUæ·˜æ±°
- **æ€§èƒ½ç‰¹æ€§**ï¼š
  - çƒ­åº¦é˜ˆå€¼ï¼š1000æ¬¡/åˆ†é’ŸåŒ¹é…ï¼Œ80%æˆåŠŸç‡
  - DFAçŠ¶æ€é™åˆ¶ï¼šé»˜è®¤1000ä¸ªçŠ¶æ€
  - å†…å­˜é™åˆ¶ï¼šé»˜è®¤10MBï¼Œå¯é…ç½®
  - LRUç¼“å­˜ï¼šé»˜è®¤100ä¸ªDFA
- **æ–‡ä»¶**:
  - kestrel-lazy-dfa/src/lib.rs (æ ¸å¿ƒç±»å‹å®šä¹‰)
  - kestrel-lazy-dfa/src/detector.rs (HotSpotDetector + SequenceStats)
  - kestrel-lazy-dfa/src/converter.rs (NfaToDfaConverter)
  - kestrel-lazy-dfa/src/cache.rs (DfaCache + LRUç®¡ç†)
  - kestrel-lazy-dfa/src/dfa.rs (LazyDfa + DfaState)
  - kestrel-lazy-dfa/tests/integration_test.rs (å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•)

#### Phase D.3: è§„åˆ™åˆ†ç±»å™¨ âœ…
- **åˆ›å»º kestrel-hybrid-engine crate**ï¼ˆ~1100è¡Œä»£ç ï¼‰
  - âœ… è§„åˆ™å¤æ‚åº¦åˆ†æï¼ˆRuleComplexityAnalyzerï¼‰
    - å¤æ‚åº¦è¯„åˆ†ç³»ç»Ÿï¼ˆ0-100åˆ†ï¼‰
    - æ£€æµ‹å­—ç¬¦ä¸²å­—é¢é‡ã€æ­£åˆ™ã€globã€å‡½æ•°è°ƒç”¨ã€capturesã€untilæ¡ä»¶
    - è‡ªåŠ¨æ¨èåŒ¹é…ç­–ç•¥
  - âœ… 4ç§åŒ¹é…ç­–ç•¥
    - AcDfa: ç®€å•å­—ç¬¦ä¸²å­—é¢é‡è§„åˆ™
    - LazyDfa: ç®€å•åºåˆ—è§„åˆ™ï¼ˆç­‰å¾…çƒ­ç‚¹æ£€æµ‹ï¼‰
    - Nfa: å¤æ‚è§„åˆ™ï¼ˆæ­£åˆ™ã€untilç­‰ï¼‰
    - HybridAcNfa: å¤æ‚è§„åˆ™ä½†åŒ…å«å­—ç¬¦ä¸²å­—é¢é‡
  - âœ… æ··åˆå¼•æ“è°ƒåº¦ï¼ˆHybridEngineï¼‰
    - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åŒ¹é…ç­–ç•¥
    - çƒ­ç‚¹åºåˆ—è‡ªåŠ¨è½¬æ¢ä¸ºDFA
    - ç­–ç•¥è·Ÿè¸ªå’Œç»Ÿè®¡
- **æµ‹è¯•è¦†ç›–**ï¼š15ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆ8å•å…ƒ+7é›†æˆï¼‰
  - âœ… å•å…ƒæµ‹è¯•ï¼šå¤æ‚åº¦åˆ†æã€ç­–ç•¥æ¨è
  - âœ… é›†æˆæµ‹è¯•ï¼šå¼•æ“åŠ è½½ã€ç­–ç•¥é€‰æ‹©ã€ç»Ÿè®¡
- **æ€§èƒ½ç‰¹æ€§**ï¼š
  - é›¶æ‹·è´äº‹ä»¶å¤„ç†ï¼ˆé€šè¿‡å¼•ç”¨ï¼‰
  - çº¿ç¨‹å®‰å…¨ç­–ç•¥æ˜ å°„ï¼ˆRwLockï¼‰
  - å¯é…ç½®çš„çƒ­åº¦é˜ˆå€¼å’ŒDFAé™åˆ¶
- **æ–‡ä»¶**:
  - kestrel-hybrid-engine/src/lib.rs (æ ¸å¿ƒç±»å‹å®šä¹‰)
  - kestrel-hybrid-engine/src/analyzer.rs (RuleComplexityAnalyzer)
  - kestrel-hybrid-engine/src/engine.rs (HybridEngine)
  - kestrel-hybrid-engine/tests/integration_test.rs (é›†æˆæµ‹è¯•)

#### Phase D.4: æ€§èƒ½éªŒè¯ä¸è°ƒä¼˜ âœ…
- **Debugæ¨¡å¼æ€§èƒ½åŸºå‡†æµ‹è¯•**
  - AC-DFA: 115 ns/op (8.69 M ops/sec) - **8.0xåŠ é€Ÿ** âœ…
  - çƒ­ç‚¹æ£€æµ‹å¼€é”€: ~90ns/evaluation
  - ç«¯åˆ°ç«¯æµ‹è¯•: 222Âµs/event (4.49K events/sec)
  - ç›®æ ‡è¾¾æˆ: 5-10xåŠ é€Ÿå®é™…è¾¾åˆ°8.0x
- **Releaseæ¨¡å¼æ€§èƒ½éªŒè¯**
  - AC-DFA: 125 ns/op (7.96 M ops/sec)
  - äº‹ä»¶å¤„ç†: 133Âµs/event (7.53K events/sec)
  - **Releaseæ¨¡å¼æå‡68%** âœ…
  - åºåˆ—åŠ è½½: 2.90Âµs/sequence
- **å†…å­˜ä½¿ç”¨éªŒè¯**
  - AC-DFA: ~100 KB (100 patterns)
  - Lazy DFA: ~1 MB (10 cached DFAs)
  - NFA: ~500 KB (100 sequences)
  - æ€»è®¡: ~1.6 MB (è¿œä½äº20MBç›®æ ‡) âœ…
- **æµ‹è¯•è¦†ç›–**: 262ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
  - 50ä¸ªå•å…ƒæµ‹è¯•
  - 19ä¸ªé›†æˆæµ‹è¯•
  - 9ä¸ªåŸºå‡†æµ‹è¯•
  - 7ä¸ªend-to-endæµ‹è¯•
- **æ–‡æ¡£å®Œå–„**
  - phase_d_report.md - Phase DæŠ€æœ¯æŠ¥å‘Š
  - benchmark_results.md - Debugæ¨¡å¼åŸºå‡†æµ‹è¯•ç»“æœ
  - debug_vs_release_comparison.md - Debug vs Releaseå¯¹æ¯”
  - phase_d_final_summary.md - Phase Då®Œæ•´æ€»ç»“æŠ¥å‘Š
- **æ€§èƒ½ç›®æ ‡è¾¾æˆ** âœ…
  - âœ… AC-DFAåŠ é€Ÿ: 8.0x (ç›®æ ‡5-10x)
  - âœ… äº‹ä»¶å»¶è¿Ÿ: 133Âµs (ç›®æ ‡<1ms)
  - âœ… ååé‡: 7.5K EPS (ç›®æ ‡>1K EPS)
  - âœ… å†…å­˜å¼€é”€: 1.6MB (ç›®æ ‡<20MB)

### å½“å‰é¡¹ç›®çŠ¶æ€ï¼ˆ2026å¹´1æœˆ14æ—¥ï¼‰

#### æµ‹è¯•è¦†ç›–
- **æ€»æµ‹è¯•æ•°**: 262ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…
- **ä»£ç åº“è§„æ¨¡**: ~18ä¸ªcrateï¼Œ~35,000+è¡ŒRustä»£ç 
- **CI/CD**: GitHub Actionsé…ç½®å®Œæ•´ï¼ˆå·²å°±ç»ªï¼Œå¾…éªŒè¯ï¼‰

#### æ¶æ„è¿›å±•
- **æ··åˆNFA+DFAä¼˜åŒ–**: Phase Då…¨éƒ¨å®Œæˆï¼ğŸ‰
  - Phase D.1 (ACå¤šæ¨¡DFA): âœ… å®Œæˆï¼ˆ19ä¸ªæµ‹è¯•ï¼‰
  - Phase D.2 (æƒ°æ€§DFAç¼“å­˜): âœ… å®Œæˆï¼ˆ30ä¸ªæµ‹è¯•ï¼‰
  - Phase D.3 (è§„åˆ™åˆ†ç±»å™¨): âœ… å®Œæˆï¼ˆ15ä¸ªæµ‹è¯•ï¼‰
  - Phase D.4 (æ€§èƒ½éªŒè¯): âœ… å®Œæˆï¼ˆReleaseæ¨¡å¼68%æå‡ï¼‰
- **åŒè¿è¡Œæ—¶**: Wasm + LuaJIT å®Œæ•´å®ç°
- **eBPFé‡‡é›†å±‚**: é›†æˆæµ‹è¯•+æ€§èƒ½åŸºçº¿å®Œæˆ
- **C FFIæ¥å£**: å®Œæ•´å®ç°ï¼Œ11ä¸ªæµ‹è¯•é€šè¿‡

#### Phase Dæ€»ç»“
- **æ€§èƒ½ç›®æ ‡è¾¾æˆ**:
  - âœ… AC-DFA: 8.0xåŠ é€Ÿï¼ˆç›®æ ‡5-10xï¼‰
  - âœ… äº‹ä»¶å»¶è¿Ÿ: 133Âµsï¼ˆç›®æ ‡<1msï¼‰
  - âœ… ååé‡: 7.5K EPSï¼ˆç›®æ ‡>1K EPSï¼‰
  - âœ… å†…å­˜å¼€é”€: 1.6MBï¼ˆç›®æ ‡<20MBï¼‰
- **æ–°å¢ä»£ç **: ~4,700è¡Œï¼ˆ3ä¸ªæ–°crateï¼‰
- **æµ‹è¯•è¦†ç›–**: 262ä¸ªæµ‹è¯•ï¼ˆ50å•å…ƒ+19é›†æˆ+7e2e+9åŸºå‡†ï¼‰
- **ç”Ÿäº§å°±ç»ª**: Releaseæ¨¡å¼éªŒè¯é€šè¿‡ï¼Œå¯æŠ•å…¥ç”Ÿäº§ç¯å¢ƒ

### æ¶æ„ä¼˜åŠ¿å·²éªŒè¯

#### 1. æ€§èƒ½ä¼˜åŠ¿
- **NFA Engine**: å•è§„åˆ™çŠ¶æ€æœºåŒ¹é… < 1Î¼s
- **EventBus**: Batch å¤„ç†æå‡ååé‡
- **StateStore**: LRU/TTL/Quota ä¸‰é‡æœºåˆ¶æ§åˆ¶å†…å­˜å¢é•¿
- **Instance Pool**: Wasm/Lua å®ä¾‹å¤ç”¨ï¼Œå‡å°‘åˆå§‹åŒ–å¼€é”€

#### 2. å¯è§‚æµ‹æ€§ä¼˜åŠ¿
- **UnifiedMetrics**: èšåˆ Engine + EventBus + Runtime æŒ‡æ ‡
- **Per-Rule Metrics**: æ¯è§„åˆ™ç‹¬ç«‹æŒ‡æ ‡ï¼ˆevaluations, alerts, eval_timeï¼‰
- **Pool Metrics**: å®ä¾‹æ± åˆ©ç”¨ç‡ã€ç­‰å¾…æ—¶é—´ã€ç¼“å­˜å‘½ä¸­ç‡
- **Prometheus Export**: æ ‡å‡†æ ¼å¼ï¼Œä¾¿äºæ¥å…¥ç›‘æ§ç³»ç»Ÿ

#### 3. å¯æ§æ€§ä¼˜åŠ¿
- **Resource Budget**: Per-rule/per-entity quota ä¿æŠ¤
- **Backpressure**: EventBus èƒŒå‹æœºåˆ¶é˜²æ­¢å†…å­˜æº¢å‡º
- **TTL/LRU**: è‡ªåŠ¨æ·˜æ±°è¿‡æœŸçŠ¶æ€
- **Graceful Degradation**: é˜»æ–­æ¨¡å¼ä¸‹å¯é™çº§åˆ°æ£€æµ‹æ¨¡å¼

### å¾…å®Œå–„æ¨¡å—ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

#### P0: ç”Ÿäº§åŒ–åŸºç¡€è®¾æ–½
- [ ] CI/CD pipelineï¼ˆç›®å‰æ„å»ºç¯å¢ƒå­˜åœ¨ cross-device link é—®é¢˜ï¼‰
- [ ] æ€§èƒ½å›å½’åŸºçº¿ï¼ˆå®šæœŸ benchmarkï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ–ï¼‰
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹ï¼ˆValgrind/Sanitizer é›†æˆï¼‰
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆé•¿æ—¶é—´é«˜è´Ÿè½½ç¨³å®šæ€§ï¼‰

#### P1: eBPF é‡‡é›†å±‚ç”Ÿäº§åŒ–
- [ ] Ringbuf polling ç¨³å®šæ€§éªŒè¯
- [ ] äº‹ä»¶åè®®ç‰ˆæœ¬åŒ–ï¼ˆè·¨å†…æ ¸ç‰ˆæœ¬å…¼å®¹ï¼‰
- [ ] å­—æ®µå®Œå¤‡æ€§ï¼ˆå½“å‰ä»…éƒ¨åˆ†å­—æ®µï¼‰
- [ ] é™çº§ç­–ç•¥ï¼ˆå†…æ ¸ä¸æ”¯æŒ eBPF æ—¶çš„ fallbackï¼‰

#### P2: å®æ—¶é˜»æ–­ï¼ˆInline/Enforceï¼‰
- [ ] LSM hooks é›†æˆ
- [ ] é˜»æ–­ç­–ç•¥ä¸æˆæƒæœºåˆ¶
- [ ] è¯¯æ€å›æ»šæœºåˆ¶
- [ ] å®¡è®¡å–è¯

#### P3: è§„åˆ™ç”Ÿæ€ä¸å·¥å…·é“¾
- [ ] EQL ç¼–è¯‘å™¨ï¼ˆeqlcï¼‰å®Œæ•´å®ç°
- [ ] è§„åˆ™åŒ…ç®¡ç†å·¥å…·
- [ ] è§„åˆ™æµ‹è¯•æ¡†æ¶
- [ ] è§„åˆ™ç°åº¦å‘å¸ƒæœºåˆ¶

### æŠ€æœ¯å€ºåŠ¡ä¸æ”¹è¿›å»ºè®®

#### 1. æ€§èƒ½ä¼˜åŒ–ç©ºé—´

##### 1.1 æ··åˆNFA+DFAç­–ç•¥ä¼˜åŒ–ï¼ˆP0 - é«˜ä¼˜å…ˆçº§ï¼‰ğŸ”¥

**èƒŒæ™¯ä¸åŠ¨æœº**ï¼š

ç°ä»£é«˜æ€§èƒ½æ­£åˆ™å¼•æ“ï¼ˆRE2ã€Hyperscanï¼‰æ™®éé‡‡ç”¨æ··åˆç­–ç•¥ï¼Œè€Œéçº¯ç²¹çš„NFAæˆ–DFAã€‚Kestrelä½œä¸ºç«¯ä¾§è¡Œä¸ºæ£€æµ‹å¼•æ“ï¼Œéœ€è¦å€Ÿé‰´ä¸šç•Œæœ€ä½³å®è·µæ¥ä¼˜åŒ–æ€§èƒ½ã€‚

**è®¾è®¡æ–¹æ¡ˆ**ï¼š

**A. å¤šæ¨¡DFAç”¨äºå…³é”®è¯/å‰ç¼€åŒ¹é…ï¼ˆAho-Corasickè‡ªåŠ¨æœºï¼‰**

åº”ç”¨åœºæ™¯ï¼š
- å­—ç¬¦ä¸²å­—é¢é‡ç›¸ç­‰æ€§ï¼š`process.name == "bash"`
- å­—ç¬¦ä¸²åŒ…å«ï¼š`process.command_line contains "ssh"`
- å­—ç¬¦ä¸²å‰ç¼€åŒ¹é…ï¼š`process.command_line startswith "/usr/bin"`
- å­—ç¬¦ä¸²åç¼€åŒ¹é…ï¼š`file.path endswith ".exe"`

å®ç°ç­–ç•¥ï¼š
1. **ç¼–è¯‘æ—¶åˆ†æ**ï¼šåœ¨EQLâ†’IRç¼–è¯‘é˜¶æ®µï¼Œåˆ†æè°“è¯ä¸­çš„å­—ç¬¦ä¸²å­—é¢é‡
2. **ACè‡ªåŠ¨æœºæ„å»º**ï¼šå°†å¸¸é‡å­—ç¬¦ä¸²æ„å»ºä¸ºAho-Corasickè‡ªåŠ¨æœº
3. **å¿«é€Ÿè¿‡æ»¤å±‚**ï¼šåœ¨NFAå¼•æ“å‰è®¾ç½®ACå¿«é€Ÿè¿‡æ»¤ï¼Œä¸åŒ¹é…çš„äº‹ä»¶ç›´æ¥è·³è¿‡è°“è¯è¯„ä¼°
4. **æ€§èƒ½é¢„æœŸ**ï¼šå­—ç¬¦ä¸²åŒ¹é…ä»O(n*m)é™ä½åˆ°O(n)ï¼Œå…¶ä¸­næ˜¯æ–‡æœ¬é•¿åº¦ï¼Œmæ˜¯æ¨¡å¼æ•°é‡

æŠ€æœ¯é€‰å‹ï¼š
- ä½¿ç”¨ `aho-corasick` Rust crateï¼ˆä¸šç•Œæ ‡å‡†å®ç°ï¼‰
- æ”¯æŒå¤§å°å†™ä¸æ•æ„ŸåŒ¹é…
- æ”¯æŒå¤šæ¨¡å¼åŒæ—¶åŒ¹é…

**B. æƒ°æ€§DFAç”¨äºçƒ­ç‚¹åºåˆ—**

åº”ç”¨åœºæ™¯ï¼š
- é¢‘ç¹åŒ¹é…çš„åºåˆ—è§„åˆ™ï¼ˆå¦‚process.execé«˜é¢‘è§¦å‘ï¼‰
- ç®€å•çš„ç¡®å®šæ€§åºåˆ—ï¼ˆæ— å¤æ‚æ•è·ç»„ã€æ— åè¡Œæ–­è¨€ï¼‰

å®ç°ç­–ç•¥ï¼š
1. **çƒ­åº¦ç»Ÿè®¡**ï¼šåœ¨NfaMetricsä¸­è·Ÿè¸ªæ¯ä¸ªåºåˆ—çš„åŒ¹é…é¢‘ç‡å’ŒæˆåŠŸç‡
2. **çƒ­ç‚¹é˜ˆå€¼**ï¼š
   - åŒ¹é…æ¬¡æ•° > 1000æ¬¡/åˆ†é’Ÿ
   - æˆåŠŸç‡ > 80%ï¼ˆé¿å…è½¬æ¢ä½å‘½ä¸­ç‡è§„åˆ™ï¼‰
   - æ— å¤æ‚è°“è¯ï¼ˆæ­£åˆ™ã€æ•è·ç»„ï¼‰
3. **åŠ¨æ€è½¬æ¢**ï¼š
   - å°†çƒ­ç‚¹NFAåºåˆ—è½¬æ¢ä¸ºDFA
   - DFAçŠ¶æ€ = (åºåˆ—çŠ¶æ€, å®ä½“é”®)çš„ç»„åˆ
   - ç¼“å­˜è½¬æ¢ç»“æœ
4. **ç¼“å­˜ç®¡ç†**ï¼š
   - LRUç¼“å­˜ï¼Œæœ€å¤šç¼“å­˜100ä¸ªDFA
   - å†…å­˜é™åˆ¶ï¼šæ¯ä¸ªDFA < 1MB
   - æ€»DFAå†…å­˜ < 10MB
5. **æ€§èƒ½é¢„æœŸ**ï¼šçƒ­ç‚¹åºåˆ—åŒ¹é…å»¶è¿Ÿä»1Î¼sé™è‡³0.1Î¼s

**C. NFAä¸DFAåˆ†å·¥**

è§„åˆ™åˆ†ç±»ç­–ç•¥ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è§„åˆ™åˆ†ç±»å™¨                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç®€å•è§„åˆ™ï¼ˆçº¯å­—é¢é‡ï¼‰          â†’ ACè‡ªåŠ¨æœºï¼ˆå¤šæ¨¡DFAï¼‰      â”‚
â”‚ çƒ­ç‚¹åºåˆ—ï¼ˆé«˜é¢‘+ç®€å•è°“è¯ï¼‰      â†’ æƒ°æ€§DFA                 â”‚
â”‚ å¤æ‚è§„åˆ™ï¼ˆæ­£åˆ™ã€æ•è·ç»„ï¼‰       â†’ NFA                    â”‚
â”‚ åŠ¨æ€è§„åˆ™ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰         â†’ NFA                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**D. æ¶æ„è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ··åˆåŒ¹é…å¼•æ“                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ACå¤šæ¨¡DFA    â”‚â”€â”€â”€â†’â”‚ çƒ­ç‚¹DFAç¼“å­˜  â”‚â”€â”€â†’â”‚ NFA Engine  â”‚ â”‚
â”‚  â”‚ (å¿«é€Ÿè¿‡æ»¤)   â”‚    â”‚ (çƒ­ç‚¹åºåˆ—)   â”‚   â”‚ (å¤æ‚è§„åˆ™)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                    â†“                    â†“      â”‚
â”‚    ä¸åŒ¹é…â†’skip            åŒ¹é…â†’alert           åŒ¹é…â†’alert â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**E. å®ç°Phaseè§„åˆ’**

**Phase D.1: Aho-Corasickå¤šæ¨¡DFAï¼ˆ2-3äººå‘¨ï¼‰**
- åˆ›å»º `kestrel-ac-dfa` crate
- å®ç°ACè‡ªåŠ¨æœºæ„å»ºå™¨
- é›†æˆåˆ°EQLç¼–è¯‘å™¨ï¼ˆå­—ç¬¦ä¸²å­—é¢é‡æå–ï¼‰
- ä¿®æ”¹NfaEngineï¼Œæ·»åŠ ACå¿«é€Ÿè¿‡æ»¤å±‚
- å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

**Phase D.2: æƒ°æ€§DFAç¼“å­˜ç³»ç»Ÿï¼ˆ3-4äººå‘¨ï¼‰**
- æ‰©å±•NfaMetricsï¼Œæ·»åŠ çƒ­åº¦ç»Ÿè®¡
- å®ç°NFAâ†’DFAè½¬æ¢ç®—æ³•
- å®ç°DFAç¼“å­˜ç®¡ç†ï¼ˆLRU + å†…å­˜é™åˆ¶ï¼‰
- çƒ­ç‚¹æ£€æµ‹é€»è¾‘
- DFAæ‰§è¡Œå¼•æ“
- æµ‹è¯• + æ€§èƒ½éªŒè¯

**Phase D.3: è§„åˆ™åˆ†ç±»å™¨ï¼ˆ1-2äººå‘¨ï¼‰**
- å®ç°è§„åˆ™å¤æ‚åº¦åˆ†æ
- è§„åˆ™åˆ†ç±»é€»è¾‘ï¼ˆAC/DFA/NFAï¼‰
- è‡ªåŠ¨ä¼˜åŒ–å†³ç­–æ ‘
- A/Bæµ‹è¯•æ¡†æ¶

**Phase D.4: æ€§èƒ½éªŒè¯ä¸è°ƒä¼˜ï¼ˆ2-3äººå‘¨ï¼‰**
- ç«¯åˆ°ç«¯æ€§èƒ½æµ‹è¯•ï¼ˆ1k EPSåœºæ™¯ï¼‰
- å†…å­˜ä½¿ç”¨åˆ†æ
- çƒ­ç‚¹è¯†åˆ«å‡†ç¡®åº¦æµ‹è¯•
- ç¼“å­˜å‘½ä¸­ç‡ä¼˜åŒ–
- æ–‡æ¡£ + æœ€ä½³å®è·µæŒ‡å—

**é¢„æœŸæ”¶ç›Š**ï¼š
- å­—ç¬¦ä¸²å­—é¢é‡è§„åˆ™ï¼š**5-10xåŠ é€Ÿ**
- çƒ­ç‚¹åºåˆ—è§„åˆ™ï¼š**2-5xåŠ é€Ÿ**
- æ•´ä½“ååé‡ï¼š**30-50%æå‡**
- å†…å­˜å¼€é”€ï¼š**< 20MB**ï¼ˆå¯æ¥å—ï¼‰
- CPUå ç”¨ï¼š**é™ä½20-30%**

**é£é™©ä¸ç¼“è§£**ï¼š
- é£é™©ï¼šDFAçŠ¶æ€çˆ†ç‚¸ï¼ˆæŸäº›å¤æ‚æ­£åˆ™ï¼‰
  - ç¼“è§£ï¼šè®¾ç½®å¤æ‚åº¦é˜ˆå€¼ï¼Œè¶…é™ä¿æŒNFA
- é£é™©ï¼šç¼“å­˜å¤±æ•ˆé¢‘ç¹
  - ç¼“è§£ï¼šæ™ºèƒ½ç¼“å­˜é¢„çƒ­ + LRUç­–ç•¥
- é£é™©ï¼šè§„åˆ™è¯­ä¹‰ä¸ä¸€è‡´
  - ç¼“è§£ï¼šä¸¥æ ¼çš„ç­‰ä»·æ€§æµ‹è¯•

**å‚è€ƒå®ç°**ï¼š
- RE2 (Google): æ··åˆNFA/DFA
- Hyperscan (Intel): å¤šæ¨¡DFA + SIMD
- libfuzzy (Rust): Aho-Corasickä¼˜åŒ–

##### 1.2 å…¶ä»–æ€§èƒ½ä¼˜åŒ–
- [ ] String â†’ Integer ID æ˜ å°„ï¼ˆrule_id, sequence_idï¼‰
- [ ] å­—æ®µè¯»å–æ‰¹é‡ hostcallï¼ˆå‡å°‘ Wasm/Lua äº¤å‰è¾¹ç•Œæ¬¡æ•°ï¼‰
- [ ] Regex/Glob é¢„ç¼–è¯‘å¥æŸ„ç¼“å­˜ä¼˜åŒ–
- [ ] NFA çŠ¶æ€æœºåˆ†åŒºï¼ˆæŒ‰ entity_key å“ˆå¸Œï¼Œæå‡ cache localityï¼‰

#### 2. å¯è§‚æµ‹æ€§å¢å¼º
- [ ] Wasm/Lua pool æŒ‡æ ‡é›†æˆåˆ° UnifiedMetrics
- [ ] Prometheus export æ–°å¢ pool metrics
- [ ] åˆ†å¸ƒå¼è¿½è¸ªï¼ˆtracingï¼‰é›†æˆ
- [ ] å‘Šè­¦èšåˆä¸å»é‡

#### 3. æµ‹è¯•è¦†ç›–
- [ ] ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ï¼ˆå®Œæ•´è§„åˆ™åŒ… + çœŸå®äº‹ä»¶æµï¼‰
- [ ] å¹¶å‘å‹åŠ›æµ‹è¯•ï¼ˆå¤šçº¿ç¨‹ã€å¤šè§„åˆ™ï¼‰
- [ ] é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•ï¼ˆ7x24hï¼‰
- [ ] å†…å­˜æ³„æ¼ä¸“é¡¹æµ‹è¯•

### ä¸‹ä¸€æ­¥å·¥ä½œè®¡åˆ’ï¼ˆ2026å¹´1æœˆæ›´æ–°ï¼‰

#### âœ… Phase Då®Œæˆæ€»ç»“ï¼ˆ2026å¹´1æœˆ14æ—¥ï¼‰
Phase D (æ··åˆNFA+DFAä¼˜åŒ–) å·²å…¨éƒ¨å®Œæˆï¼æ‰€æœ‰æ€§èƒ½ç›®æ ‡å‡å·²è¾¾æˆæˆ–è¶…è¶Šï¼š
- âœ… Phase D.1: AC-DFAå¼•æ“ - 8.0xåŠ é€Ÿ
- âœ… Phase D.2: æƒ°æ€§DFAç¼“å­˜ç³»ç»Ÿ
- âœ… Phase D.3: è§„åˆ™åˆ†ç±»å™¨å’Œæ··åˆå¼•æ“
- âœ… Phase D.4: æ€§èƒ½éªŒè¯ä¸è°ƒä¼˜ - Releaseæ¨¡å¼68%æå‡

**æ–‡æ¡£äº¤ä»˜ç‰©**:
- docs/phase_d_report.md - Phase DæŠ€æœ¯æŠ¥å‘Š
- docs/benchmark_results.md - æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ
- docs/debug_vs_release_comparison.md - Debug vs Releaseå¯¹æ¯”
- docs/phase_d_final_summary.md - Phase Då®Œæ•´æ€»ç»“æŠ¥å‘Š

#### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰- ç”Ÿäº§ç¯å¢ƒå‡†å¤‡ ğŸ”¥
1. **CI/CD pipelineéªŒè¯**
   - [ ] ä¿®å¤cross-device linké—®é¢˜
   - [ ] è®¾ç½®GitHub Actionsè‡ªåŠ¨è¿è¡Œ
   - [ ] æ·»åŠ æ€§èƒ½å›å½’æ£€æµ‹ï¼ˆé˜²æ­¢æ€§èƒ½é€€åŒ–ï¼‰
2. **çœŸå®EQLè§„åˆ™æµ‹è¯•**
   - [ ] ä½¿ç”¨çœŸå®EQLè§„åˆ™æµ‹è¯•æ··åˆå¼•æ“
   - [ ] éªŒè¯ç­–ç•¥é€‰æ‹©å‡†ç¡®æ€§
   - [ ] æµ‹è¯•é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§
3. **æ–‡æ¡£å®Œå–„**
   - [ ] AC-DFAä½¿ç”¨æ–‡æ¡£
   - [ ] Lazy-DFAé…ç½®æŒ‡å—
   - [ ] æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

#### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰- å¯é€‰ä¼˜åŒ–æ–¹å‘
1. **è¿›ä¸€æ­¥æ€§èƒ½ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰
   - [ ] SIMDä¼˜åŒ–å­—ç¬¦ä¸²åŒ¹é…
   - [ ] å¹¶è¡ŒåŒ–äº‹ä»¶å¤„ç†
   - [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
2. **å¯è§‚æµ‹æ€§å¢å¼º**
   - [ ] Wasm/Lua poolæŒ‡æ ‡é›†æˆåˆ°UnifiedMetrics
   - [ ] Prometheus exportæ–°å¢pool metrics
   - [ ] åˆ†å¸ƒå¼è¿½è¸ªï¼ˆtracingï¼‰é›†æˆ

#### åç»­ä¼˜å…ˆçº§ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰
1. **eBPF ç”Ÿäº§åŒ–**ï¼ˆP1ï¼‰:
   - Ringbufç¨³å®šæ€§éªŒè¯
   - äº‹ä»¶åè®®ç‰ˆæœ¬åŒ–
   - é™çº§ç­–ç•¥ï¼ˆå†…æ ¸ä¸æ”¯æŒeBPFï¼‰
2. **å®æ—¶é˜»æ–­**ï¼ˆP2ï¼‰:
   - LSM hooksé›†æˆ
   - é˜»æ–­ç­–ç•¥ä¸æˆæƒæœºåˆ¶
   - è¯¯æ€å›æ»šæœºåˆ¶
3. **è§„åˆ™ç”Ÿæ€**ï¼ˆP3ï¼‰:
   - EQLç¼–è¯‘å™¨å®Œæ•´å®ç°
   - è§„åˆ™åŒ…ç®¡ç†å·¥å…·
   - è§„åˆ™æµ‹è¯•æ¡†æ¶

---

## 1. ç›®æ ‡ä¸è¾¹ç•Œ

### 1.1 ç›®æ ‡
- **ç«¯ä¾§ï¼ˆç¬”è®°æœ¬ï¼‰**ï¼š1k EPS å³°å€¼ä¸‹ç¨³å®šè¿è¡Œï¼›ä½ CPU å ç”¨ã€å¯æ§å†…å­˜ï¼›å¯é…ç½®ä½åŠŸè€—ç­–ç•¥ã€‚
- **å®æ—¶é˜»æ–­**ï¼šæ–‡ä»¶ / è¿›ç¨‹ / å†…å­˜ç›¸å…³å…³é”® API ä¸ç³»ç»Ÿè°ƒç”¨ï¼ˆè§ Â§8ï¼‰ã€‚
- **ç¦»çº¿å›æ”¾**ï¼šåŒæ ¸æ£€æµ‹ï¼Œç»“æœ**å®Œå…¨å¯å¤ç°**ï¼ˆåŒä¸€æ—¥å¿—+è§„åˆ™+å¼•æ“ç‰ˆæœ¬ â†’ åŒä¸€å‘Šè­¦ä¸è¯æ®ï¼‰ã€‚
- **è§„åˆ™æ— éœ€é‡ç¼–è¯‘å¼•æ“**ï¼šè§„åˆ™åŒ…çƒ­åŠ è½½ï¼Œæ¥è‡ªæœ¬åœ°æ–‡ä»¶ï¼ˆwatch + åŸå­åˆ‡æ¢ï¼‰ã€‚
- **ç±» Unix å¯ç§»æ¤**ï¼šLinux é¦–å‘ï¼›Harmonyï¼ˆéƒ¨åˆ†å…¼å®¹ Linuxï¼‰æŒ‰èƒ½åŠ›é€‚é…ã€‚

### 1.2 æ˜ç¡®è¾¹ç•Œï¼ˆv0.2 ä¸æ‰¿è¯ºï¼‰
- ä¸æŠŠ GPU å½“ä½œç«¯ä¾§å®æ—¶é˜»æ–­çš„ä¸»è·¯å¾„ï¼ˆåŸå› è§ Â§11ï¼‰ã€‚GPU ä»…ä½œä¸ºå¯é€‰åŠ é€Ÿæ–¹å‘ï¼ˆäº‘/ç¦»çº¿/æ‰¹å¤„ç†ï¼‰ã€‚
- ä¸è¿½æ±‚â€œå®Œæ•´è¦†ç›–æ‰€æœ‰ EQL æ‰©å±•è¯­æ³•â€ï¼ˆå¦‚ pipeline çš„å…¨é‡ç”Ÿæ€ï¼‰ï¼›é€‰æ‹©ç¨³å®šå¯å®ç°ã€é€‚åˆå®‰å…¨æ£€æµ‹çš„å…¼å®¹å­é›†ï¼ˆè§ Â§7ï¼‰ã€‚

---

## 2. æ€»ä½“æ¶æ„ï¼ˆå¯æ’æ‹”ã€å¯é™çº§ã€å¯å¤ç°ï¼‰

### 2.1 åˆ†å±‚æ¶æ„å›¾ï¼ˆé€»è¾‘ï¼‰
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Rule Packages (local)               â”‚
â”‚      EQL DSL -> eqlc -> IR -> (Wasm predicate | Lua)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ hotload/rollback
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Engine Control Plane                                     â”‚
â”‚  - RuleManager  - Capability/Mode  - Metrics/Tracing     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection Data Plane                                      â”‚
â”‚  EventBus -> Partition -> Worker Threads                  â”‚
â”‚    â”œâ”€ NFA Sequence Engine (Host)                          â”‚
â”‚    â”œâ”€ Predicate Runtime: Wasm OR LuaJIT                   â”‚
â”‚    â”œâ”€ StateStore (TTL/LRU/Quota)                          â”‚
â”‚    â””â”€ Actions/Alerts (inline/async/offline policy)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     ^
                     â”‚ normalized events
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Sources (pluggable)                                 â”‚
â”‚  - eBPF tracepoints/kprobe + ringbuf                      â”‚
â”‚  - LSM/eBPF-LSM hooks (é˜»æ–­ç‚¹)                            â”‚
â”‚  - audit / fanotify (å¯é€‰)                                â”‚
â”‚  - Offline replay (binary log)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸‰ç§è¿è¡Œæ¨¡å¼ï¼ˆåŒæ ¸ï¼‰
- **Inline/Enforce**ï¼šé˜»æ–­è·¯å¾„ï¼ˆä¸¥æ ¼é¢„ç®—ã€è§„åˆ™å­é›†ã€å¯é™çº§ï¼‰
- **Online/Detect**ï¼šåœ¨çº¿æ£€æµ‹ï¼ˆå…¨é‡åºåˆ—+å¯ŒåŒ–ï¼‰
- **Offline/Replay**ï¼šç¦»çº¿å›æ”¾ï¼ˆåŒåºåˆ—å¼•æ“ã€åŒè°“è¯è¿è¡Œæ—¶ï¼›åŠ¨ä½œæ¥å£è¢«ç¦ç”¨/ä»¿çœŸï¼‰

---

## 3. äº‹ä»¶æ¨¡å‹ä¸ Schemaï¼ˆä¸ºæ€§èƒ½ã€EQL ä¸å¯å¤ç°æœåŠ¡ï¼‰

### 3.1 Schema åŸåˆ™
- **å¼ºç±»å‹å­—æ®µ**ï¼šé¿å…è¿è¡Œæ—¶å­—ç¬¦ä¸²è§£æä¸éšå¼ç±»å‹è½¬æ¢å¼€é”€/æ­§ä¹‰ã€‚
- **å­—æ®µ ID åŒ–**ï¼š`field_path -> field_id(u32)` åœ¨åŠ è½½è§„åˆ™æ—¶è§£æï¼›è¿è¡Œæ—¶ä»¥ ID è®¿é—®ã€‚
- **å¯å¤ç°æ—¶é—´è¯­ä¹‰**ï¼šè®°å½• `ts_mono_ns`ï¼ˆå•è°ƒï¼‰ç”¨äºçª—å£/åºåˆ—ï¼›è®°å½• `ts_wall_ns` ç”¨äºå–è¯å±•ç¤ºã€‚

### 3.2 äº‹ä»¶ç»“æ„ï¼ˆå†…éƒ¨å»ºè®®ï¼‰
- `event_type_id: u16`
- `ts_mono_ns: u64`
- `ts_wall_ns: u64`
- `entity_key: u128`ï¼ˆä¾‹å¦‚ pid+start_time æˆ–è€…å®¹å™¨/ä¼šè¯æ‰©å±•ï¼‰
- `fields: smallvec<(field_id, typed_value)>`ï¼ˆç¨€ç–å­˜å‚¨ï¼Œé›¶æ‹·è´å­—ç¬¦ä¸²/bytes è§†æƒ…å†µï¼‰

---

## 4. é‡‡é›†å±‚ä¸é€‚é…ï¼ˆLinux/Harmonyï¼‰

### 4.1 Linux é¦–é€‰è·¯å¾„ï¼šeBPF +ï¼ˆè§‚æµ‹/é˜»æ–­åˆ†ç¦»ï¼‰
- **è§‚æµ‹**ï¼štracepoints/kprobes + ringbuf â†’ ç”¨æˆ·æ€è§„èŒƒåŒ–
- **é˜»æ–­**ï¼šä¼˜å…ˆ **LSM hooks**ï¼ˆå¦‚ `bprm_check_security`, `file_open`, `inode_*`, `socket_connect` ç­‰ï¼‰
  - è‹¥å†…æ ¸æ”¯æŒï¼š**eBPF LSM**ï¼ˆæ€§èƒ½ä¸å¯ç»´æŠ¤æ€§æ›´å¥½ï¼‰
  - å¦åˆ™ï¼šé€€åŒ–åˆ° LSM æ¨¡å—/å…¶ä»–æœºåˆ¶ï¼ˆæŒ‰å‘è¡Œç‰ˆèƒ½åŠ›ï¼‰

> è¯´æ˜ï¼šé˜»æ–­å±äºâ€œå†³ç­–ç‚¹â€ï¼Œå¿…é¡»é€‰æ‹©èƒ½åœ¨åŠ¨ä½œå‘ç”Ÿå‰ä»‹å…¥çš„ hookï¼›çº¯ tracepoint åªèƒ½äº‹åè§‚æµ‹ã€‚

### 4.2 Harmony/ç±» Unix
- ä»¥â€œèƒ½åŠ›æ¢æµ‹ + é€‚é…å±‚â€æ–¹å¼å®ç°ï¼š
  - `EventSource.capabilities()` æè¿°å¯æä¾›çš„äº‹ä»¶ç±»å‹/å­—æ®µ/é˜»æ–­ç‚¹
  - è§„åˆ™å…´è¶£ä¸‹æ¨ä¸é˜»æ–­ç‚¹æ˜ å°„æŒ‰å¹³å°èƒ½åŠ›è£å‰ª

---

## 5. æ£€æµ‹æ ¸å¿ƒï¼šHost æ‰§è¡Œ NFAï¼ˆåºåˆ—/çª—å£/å…³è”ï¼‰ï¼ŒWasm/Lua æ‰§è¡Œè°“è¯

### 5.1 ä¸ºä»€ä¹ˆé€‰æ‹©æ–¹æ¡ˆ Aï¼ˆHost NFAï¼‰
- **æ€§èƒ½å¯æ§**ï¼šNFA/çª—å£æ·˜æ±°/åˆ†åŒºçŠ¶æ€ç®¡ç†åœ¨ Rust å†…æ ¸å®Œæˆï¼Œé¿å…æ¯è§„åˆ™é‡å¤å®ç°åºåˆ—é€»è¾‘ã€‚
- **æ›´é€‚åˆé˜»æ–­è·¯å¾„**ï¼šå¯ä»¥æŠŠ inline è§„åˆ™çº¦æŸä¸ºâ€œæœ‰é™çŠ¶æ€ + å¿«è°“è¯â€ï¼Œä¿éšœå»¶è¿Ÿä¸Šç•Œã€‚
- **æ›´æ˜“åšåˆ°å¯å¤ç°**ï¼šçŠ¶æ€æ·˜æ±°ã€äº‹ä»¶æ’åºã€çª—å£è¾¹ç•Œç”±å®¿ä¸»ç»Ÿä¸€å®ç°ï¼Œå‡å°‘è¿è¡Œæ—¶å·®å¼‚ã€‚

### 5.2 NFA æ‰§è¡Œè¦ç‚¹
- æŒ‰ `sequence by <entity>` åˆ†åŒºï¼šæ¯ä¸ª `entity_key` ç‹¬ç«‹ç»´æŠ¤ partial matches
- `maxspan`ï¼špartial match ä»¥ `ts_mono_ns` è¿›è¡Œ TTL æ·˜æ±°
- `until`ï¼šç»ˆæ­¢äº‹ä»¶åˆ°æ¥æ—¶æ¸…ç†ç›¸å…³ partial matches
- çŠ¶æ€å­˜å‚¨ï¼š**åˆ†ç‰‡ + TTL/LRU + é…é¢**
  - é…é¢å»ºè®®ï¼šæŒ‰è§„åˆ™/æŒ‰å®ä½“åŒç»´åº¦é™åˆ¶ï¼Œé¿å…å•å®ä½“æˆ–å•è§„åˆ™æ”¾å¤§å†…å­˜

---

## 6. åŒè¿è¡Œæ—¶è®¾è®¡ï¼šWasm + LuaJIT å¹¶å­˜ï¼ˆç»Ÿä¸€ Host API/IRï¼‰

### 6.1 å®šä½ä¸å–èˆ
- **Wasm**ï¼šæ ‡å‡†åŒ–ã€å¯ç§»æ¤ã€ä¾¿äºè·¨å¹³å°ä¸€è‡´æ€§ï¼ˆå°¤å…¶ offline/replay ä¸äº‘ç«¯ï¼‰
- **LuaJIT**ï¼šç«¯ä¾§æ€§èƒ½é€šå¸¸ä¼˜ç§€ï¼ˆJITï¼‰ã€å¼€å‘è¿­ä»£å¿«ï¼Œé€‚åˆå†…éƒ¨/å¯ä¿¡è§„åˆ™å¿«é€Ÿè½åœ°

ä½ æåˆ°â€œè§„åˆ™åŸºæœ¬å¯ä¿¡â€â€”â€”è¿™å…è®¸æˆ‘ä»¬åœ¨ **trusted æ¨¡å¼**ä¸‹æ”¾æ¾éƒ¨åˆ†é™åˆ¶ä»¥æ¢å–æ€§èƒ½ï¼Œä½†ä»å»ºè®®ä¿ç•™æœ€å°çš„é²æ£’æ€§è¾¹ç•Œï¼ˆè§ Â§10ï¼‰ã€‚

### 6.2 ç»Ÿä¸€æ¥å£ï¼šPredicate ABIï¼ˆå…³é”®ï¼‰
æ— è®º Wasm è¿˜æ˜¯ LuaJITï¼Œéƒ½å®ç°åŒä¸€â€œè°“è¯æ¥å£â€ï¼Œä¾› NFA è°ƒç”¨ï¼š

- `pred_init(ctx) -> ok`
- `pred_eval(event, ctx) -> bool`  
- ï¼ˆå¯é€‰ï¼‰`pred_capture(event, ctx) -> captures`ï¼šè¿”å›ç”¨äºå‘Šè­¦çš„å­—æ®µæå–ç»“æœ

å…¶ä¸­ `ctx` åªé€šè¿‡ Host API è®¿é—®ï¼š
- äº‹ä»¶å­—æ®µè¯»å–ï¼ˆfield_idï¼‰
- å¸¸é‡è¡¨/é¢„ç¼–è¯‘ regex å¥æŸ„
- è½»é‡çŠ¶æ€è®¿é—®ï¼ˆå¦‚éœ€è¦ï¼Œé€šå¸¸åºåˆ—çŠ¶æ€ç”± Host ç®¡ï¼‰

### 6.3 Host APIï¼ˆv1ï¼‰è¦ç‚¹ï¼ˆWasm/Lua å…±ç”¨ï¼‰
**äº‹ä»¶è¯»å–**
- `schema_resolve(path) -> field_id`ï¼ˆåŠ è½½æœŸå®Œæˆï¼Œè¿è¡ŒæœŸç”¨ idï¼‰
- `event_get_<type>(event_handle, field_id) -> option<T>`
- `event_type(event_handle) -> event_type_id`
- `event_entity(event_handle) -> entity_key`

**å·¥å…·**
- `re_match(re_id, str)` / `glob_match(glob_id, str)`
- `str_eq_ci(a,b)`ï¼ˆå¯é€‰ï¼šå¤§å°å†™ä¸æ•æ„Ÿå¸¸ç”¨åŠ é€Ÿï¼‰
- `hash_xx64(bytes)`ï¼ˆå¯é€‰ï¼šç”¨äºé”®è®¡ç®—ï¼‰

**åŠ¨ä½œ/å‘Šè­¦**
- `alert_emit(record)`
- `action_block(...)`ï¼ˆinline æ¨¡å¼å…è®¸ï¼›offline æ¨¡å¼ç¦ç”¨æˆ–ä»¿çœŸè¿”å›ï¼‰

> å®ç°æ–¹å¼ï¼š  
> - Wasmï¼šwasmtime host functionsï¼ˆå°½é‡æ‰¹é‡è¯»å–/å‡å°‘ hostcallï¼‰  
> - LuaJITï¼šC FFI å‡½æ•°è¡¨ï¼ˆæˆ– Rust å¯¼å‡º C ABIï¼‰ï¼Œå­—æ®µ ID ç›´æ¥ä¼  u32

### 6.4 è§„åˆ™å·¥ç¨‹å»ºè®®
- EQL é»˜è®¤ç¼–è¯‘ä¸º **Wasm è°“è¯**ï¼ˆä¸€è‡´æ€§å¥½ï¼‰
- å†…éƒ¨/é«˜æ€§èƒ½åœºæ™¯å…è®¸ EQLâ†’Luaï¼ˆæˆ–æ‰‹å†™ Lua predicateï¼‰ä½œä¸ºå¯é€‰åç«¯
- å¼•æ“æ”¯æŒåŒä¸€è§„åˆ™é›†æ··åˆåŠ è½½ï¼šéƒ¨åˆ†è§„åˆ™ Wasmï¼Œéƒ¨åˆ† Lua

---

## 7. EQL æ”¯æŒçŸ©é˜µï¼ˆå¿…é¡»/å¯é€‰/ä¸æ”¯æŒä¸æ›¿ä»£ï¼‰

> é€‰æ‹©åŸºçº¿ï¼š**Elastic EQL çš„ç¨³å®šæ ¸å¿ƒè¯­ä¹‰ï¼ˆsequence/where/by/maxspan/untilï¼‰**ï¼Œè£å‰ªæ‰å¯¹ç«¯ä¾§ä»·å€¼ä½ã€å®ç°æˆæœ¬é«˜æˆ–è¯­ä¹‰æ˜“åˆ†æ­§çš„éƒ¨åˆ†ï¼ˆå¦‚å¤æ‚ pipelineï¼‰ã€‚  
> ç›®æ ‡æ˜¯â€œç”¨äºå®‰å…¨è¡Œä¸ºæ£€æµ‹è¶³å¤Ÿå¼ºã€è¯­ä¹‰ç¨³å®šã€å¯æµ‹è¯•å¯å¤ç°â€ã€‚

### 7.1 å¿…é¡»å…¼å®¹ï¼ˆv1 å¿…åšï¼‰
| ç±»åˆ« | ç‰¹æ€§ | è¯´æ˜ |
|---|---|---|
| æŸ¥è¯¢ç»“æ„ | `event where <expr>` | å•äº‹ä»¶è§„åˆ™ |
| åºåˆ— | `sequence [A where ...] [B where ...] ...` | å¤šæ­¥åºåˆ— |
| å…³è” | `sequence by <field>` | ä»¥å®ä½“é”®åˆ†ç»„ï¼ˆå¸¸ç”¨ï¼š`process.entity_id`/`process.pid`+startï¼‰ |
| çª—å£ | `with maxspan=<duration>` | åºåˆ—æœ€å¤§æ—¶é—´è·¨åº¦ |
| ç»ˆæ­¢ | `until [X where ...]` | ç»ˆæ­¢/æ¸…ç† partial match |
| æ¡ä»¶è¡¨è¾¾å¼ | `and/or/not` | é€»è¾‘è¿ç®— |
| æ¯”è¾ƒ | `== != < <= > >=` | æ•°å€¼/å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆæ˜ç¡®ç±»å‹è§„åˆ™ï¼‰ |
| é›†åˆ | `in (a,b,c)` | å¸¸é‡é›†åˆåŒ¹é…ï¼ˆç¼–è¯‘æœŸä¼˜åŒ–ä¸º hash/setï¼‰ |
| å­—ç¬¦ä¸² | `contains`, `startswith`, `endswith` | å¸¸ç”¨ IOC/è·¯å¾„åŒ¹é… |
| æ­£åˆ™/é€šé… | `regex`, `wildcard/glob`ï¼ˆé€‰ä¸€å¥—è¯­ä¹‰å›ºå®šï¼‰ | å»ºè®®å®ç° `wildcard`ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰+ å¯é€‰ `regex` |
| ç¼ºå¤±å­—æ®µ | `field == null` / `missing` è¯­ä¹‰ | å¿…é¡»æ˜ç¡®ï¼šç¼ºå¤±=Null è¿˜æ˜¯ä¸‰å€¼é€»è¾‘ï¼ˆå»ºè®®äºŒå€¼+æ˜¾å¼ missing åˆ¤æ–­ï¼‰ |
| è¾“å‡º | å‘Šè­¦å­—æ®µæå–ï¼ˆrule metadata + capturesï¼‰ | æ”¯æŒæŠŠå…³é”®å­—æ®µå†™å…¥å‘Šè­¦ |

### 7.2 å¯é€‰æ”¯æŒï¼ˆv1.5 / v2ï¼‰
| ç±»åˆ« | ç‰¹æ€§ | ä»·å€¼ | å¤‡æ³¨ |
|---|---|---|---|
| è´Ÿæ¡ä»¶åºåˆ— | `sequence ... ![X where ...] ...` | è¡¨è¾¾â€œæœŸé—´æœªå‘ç”Ÿâ€ | å®ç°å¤æ‚ï¼ˆéœ€è¦åŒºé—´è¡¥é›†ï¼‰ä½†å¯¹æ£€æµ‹å¾ˆå¼º |
| æ•°ç»„å­—æ®µ | `any`/`all` è¯­ä¹‰ | é€‚é…æŸäº›æ—¥å¿—æº | éœ€è¦ç»Ÿä¸€å­—æ®µæ¨¡å‹ |
| æ•°å­¦å‡½æ•° | `length()`, `cidrMatch()` ç­‰ | ç½‘ç»œ/å­—ç¬¦ä¸²å¢å¼º | Host æä¾›å†…å»ºå‡½æ•°æ›´å¿« |
| pipe/pipeline | `| where ...`ã€`| sort` ç­‰ | SIEM ä¾§æ›´å¸¸è§ | ç«¯ä¾§ä»·å€¼æœ‰é™ï¼Œå»ºè®®è£å‰ª |

### 7.3 ä¸æ”¯æŒï¼ˆæ˜ç¡®æ›¿ä»£ï¼‰
| ç‰¹æ€§ | ä¸æ”¯æŒåŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|---|---|---|
| å¤æ‚ joinï¼ˆè·¨ç´¢å¼•/è·¨å¤§è¡¨ï¼‰ | ç«¯ä¾§èµ„æºä¸é€‚åˆ | äº¤ç»™äº‘ç«¯/ç¦»çº¿åˆ†æï¼›æˆ–é€šè¿‡åºåˆ—+state è¿‘ä¼¼ |
| ä»»æ„è„šæœ¬åµŒå…¥ EQL | è¯­ä¹‰ä¸ç¨³å®š/å®‰å…¨æ€§å·® | ç”¨ Wasm/Lua predicate æ‰©å±•ç‚¹ |
| å…¨é‡ pipeline ç”Ÿæ€ | å®ç°ä¸å…¼å®¹æˆæœ¬é«˜ | ä¿ç•™æœ€å°å¿…è¦è¾“å‡ºä¸è¿‡æ»¤èƒ½åŠ› |

> å»ºè®®äº¤ä»˜ç‰©ï¼šå»ºç«‹ä¸€å¥— **EQL å…¼å®¹æ€§æµ‹è¯•åŸºçº¿**ï¼ˆè¯­æ³•ã€è¯­ä¹‰ã€è¾¹ç•Œæ—¶é—´çª—ã€ç¼ºå¤±å­—æ®µã€ç±»å‹è½¬æ¢ï¼‰ï¼Œè¿™æ˜¯â€œçœ‹èµ·æ¥å‰å®³ä¸”èƒ½é•¿æœŸç»´æŠ¤â€çš„å…³é”®èµ„äº§ã€‚

---

## 8. å®æ—¶é˜»æ–­èŒƒå›´ä¸å®ç°å»ºè®®ï¼ˆLinuxï¼‰

ä½ ç»™å®šçš„é˜»æ–­èŒƒå›´ï¼š**æ–‡ä»¶ã€è¿›ç¨‹ã€å†…å­˜ã€å…³é”® API ä¸ç³»ç»Ÿè°ƒç”¨**ã€‚å»ºè®®å°†â€œé˜»æ–­ç‚¹â€å·¥ç¨‹åŒ–ä¸ºèƒ½åŠ›çŸ©é˜µï¼Œå¹¶æŒ‰å¹³å°èƒ½åŠ›é€æ­¥è¦†ç›–ï¼š

### 8.1 è¿›ç¨‹ç±»ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
- `execve/execveat`ï¼šé˜»æ–­å¯ç–‘è¿›ç¨‹å¯åŠ¨ï¼ˆLSM `bprm_check_security`ï¼‰
- `ptrace`ï¼šé˜»æ–­è°ƒè¯•/æ³¨å…¥é“¾è·¯ï¼ˆLSM `ptrace_access_check` ç­‰ï¼‰
- `bpf`, `perf_event_open`ï¼šé™åˆ¶ä¾§è½½è§‚æµ‹/ææƒé¢ï¼ˆè§†åœºæ™¯ï¼‰

### 8.2 æ–‡ä»¶ç±»ï¼ˆå¼ºéœ€æ±‚ï¼‰
- `open/openat` å†™å…¥ã€`rename`, `unlink`, `chmod/chown`ï¼šå…³é”®è·¯å¾„ä¿æŠ¤
- å¯ç”¨ hookï¼š`file_open`, `inode_permission`, `security_path_*`ï¼ˆä¾å†…æ ¸ç‰ˆæœ¬é€‰æ‹©ï¼‰
- è¡¥å……ï¼šå¿…è¦æ—¶ç»“åˆ **fanotify** åšç”¨æˆ·æ€é˜»æ–­ï¼ˆä½†å»¶è¿Ÿä¸è¾¹ç•Œéœ€è¯„ä¼°ï¼‰

### 8.3 ç½‘ç»œç±»ï¼ˆå¸¸ç”¨ï¼‰
- `connect` / `sendto` / DNSï¼šé˜»æ–­å¤–è”
- hookï¼š`socket_connect`ï¼ˆLSMï¼‰/ cgroup hooksï¼ˆéƒ¨åˆ†åœºæ™¯æ›´åˆé€‚ï¼‰

### 8.4 å†…å­˜/æ³¨å…¥ç±»ï¼ˆå¤æ‚ä½†é‡è¦ï¼‰
- `mmap(PROT_EXEC)`, `mprotect` æå‡ä¸ºå¯æ‰§è¡Œã€`process_vm_writev`ã€`memfd_create` ç­‰
- ç°å®å»ºè®®ï¼šå…ˆåš**è§‚æµ‹+å‘Šè­¦**ï¼Œé˜»æ–­é€æ­¥å¼•å…¥ï¼ˆé¿å…è¯¯æ€ä¸å…¼å®¹æ€§é£é™©ï¼‰

---

## 9. ç¦»çº¿å®Œå…¨å¯å¤ç°ï¼ˆå¼ºçº¦æŸä¸‹çš„å·¥ç¨‹è®¾è®¡ï¼‰

è¦åšåˆ°â€œå®Œå…¨å¯å¤ç°â€ï¼Œå¿…é¡»æ§åˆ¶ä¸‰ä»¶äº‹ï¼š

1. **äº‹ä»¶æ’åºç¡®å®šæ€§**ï¼šä»¥ `ts_mono_ns` + `event_id(é€’å¢)` åšç¨³å®šæ’åºï¼›åŒä¸€æ—¶é—´æˆ³å†²çªæ—¶ä¹Ÿç¡®å®šã€‚
2. **è§„åˆ™ä¸å¼•æ“ç‰ˆæœ¬é”å®š**ï¼šç¦»çº¿å›æ”¾è®°å½• `rule_pack_hash`ã€`engine_build_id`ã€`schema_version`ã€‚
3. **åŒä¸€è¯­ä¹‰å®ç°**ï¼šNFA/çª—å£/æ·˜æ±°åœ¨ Host ç»Ÿä¸€æ‰§è¡Œï¼›è°“è¯è¿è¡Œæ—¶å·®å¼‚ï¼ˆWasm vs Luaï¼‰éœ€è¦å¯é€‰â€œç¡®å®šæ€§æ¨¡å¼â€ï¼ˆLuaJIT åœ¨ç¦»çº¿å¯åˆ‡ interpreter/å…³é—­æŸäº›ä¸ç¡®å®šè¡Œä¸ºï¼‰ã€‚

**æ—¥å¿—å»ºè®®æœ€å°åŒ…å«**ï¼šè§„èŒƒåŒ–äº‹ä»¶ï¼ˆå­—æ®µID+å¼ºç±»å‹å€¼ï¼‰ã€schemaç‰ˆæœ¬ã€mono/wall æ—¶é—´ã€entity_keyã€source_idã€åŸå§‹å­—æ®µå¯é€‰ï¼ˆç”¨äºå–è¯å±•ç¤ºï¼‰ã€‚

---

## 10. â€œè§„åˆ™åŸºæœ¬å¯ä¿¡â€ä¸‹çš„æ€§èƒ½ç­–ç•¥ï¼ˆæ”¾æ¾å®‰å…¨ä½†ä¸æ”¾æ¾é²æ£’æ€§ï¼‰

å³ä¾¿è§„åˆ™å¯ä¿¡ï¼Œç«¯ä¾§å·¥ç¨‹ä»è¦é˜²â€œè¯¯å†™è§„åˆ™å¯¼è‡´å¼•æ“æŠ–åŠ¨/å†…å­˜æ³„æ¼å¼å¢é•¿â€ã€‚å»ºè®®æä¾›ä¸¤æ¡£æ¨¡å¼ï¼š

### 10.1 Trusted æ¨¡å¼ï¼ˆé»˜è®¤å†…éƒ¨/ä¼ä¸šè‡ªæœ‰è§„åˆ™ï¼‰
- Wasmï¼šå¯æé«˜ fuel ä¸Šé™ã€å…è®¸æ›´å¤§å†…å­˜
- LuaJITï¼šå¼€å¯ JITã€å…è®¸æ›´é«˜æŒ‡ä»¤é¢„ç®—
- ä»ä¿ç•™ï¼š**è¶…æ—¶ç›‘æ§ã€çŠ¶æ€é…é¢ã€å…³é”®åŠ¨ä½œå®¡è®¡**ï¼ˆé¿å…äº‹æ•…ä¸å¯å®šä½ï¼‰

### 10.2 Strict æ¨¡å¼ï¼ˆé¢å‘ç¬¬ä¸‰æ–¹è§„åˆ™/æœªçŸ¥æ¥æºï¼‰
- æ›´ä¸¥æ ¼çš„ fuel/å†…å­˜/hostcall é™åˆ¶
- æ›´ä¸¥æ ¼ capabilityï¼ˆé˜»æ–­éœ€æ˜¾å¼æˆæƒï¼‰

---

## 11. åŠ æ€§èƒ½ä¼˜åŒ–


**æ›´ç°å®çš„ç«¯ä¾§ä¼˜å…ˆçº§**ï¼š
- CPU SIMDï¼ˆSSE/AVXï¼‰ä¼˜åŒ–å­—ç¬¦ä¸²åŒ¹é…/å“ˆå¸Œ
- æ‰¹å¤„ç†ï¼ˆbatchingï¼‰å‡å°‘ hostcall
- è§„åˆ™å…´è¶£ä¸‹æ¨ï¼ˆeBPF é¢„è¿‡æ»¤ï¼‰é™ä½äº‹ä»¶é‡
- å¤šæ ¸åˆ†åŒºï¼ˆæŒ‰ entity_key æˆ– event_type åˆ†åŒºï¼‰é¿å…é”ç«äº‰

---

## 12. å·¥ç¨‹è½åœ°è·¯çº¿å›¾ï¼ˆv0.2 â†’ v1.0ï¼‰ä¸å·¥ä½œé‡é¢„ä¼°

ä»¥ä¸‹ä»¥â€œäººå‘¨ï¼ˆperson-weekï¼‰â€ç²—ä¼°ï¼›å‡è®¾ 4 äººæ ¸å¿ƒå›¢é˜Ÿï¼ˆRust å†…æ ¸Ã—2ã€eBPFÃ—1ã€è§„åˆ™ç¼–è¯‘/æµ‹è¯•Ã—1ï¼‰ï¼Œå¯å¹¶è¡Œã€‚

### Phase 0ï¼šæ¶æ„éª¨æ¶ä¸å¯è·‘é€šé“¾è·¯ï¼ˆ3â€“5 äººå‘¨ï¼‰
- äº‹ä»¶ Schema v1ï¼ˆå­—æ®µIDã€ç±»å‹ç³»ç»Ÿã€è§„èŒƒåŒ–åº“ï¼‰
- EventBusï¼ˆæ‰¹å¤„ç†ã€èƒŒå‹ã€åˆ†åŒºç­–ç•¥åŸå‹ï¼‰
- RuleManagerï¼ˆæœ¬åœ°ç›®å½•åŠ è½½ã€ç‰ˆæœ¬åˆ‡æ¢ã€åŸå­æ›¿æ¢ï¼‰
- æœ€å°å‘Šè­¦é€šè·¯ï¼ˆalert è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶/stdoutï¼‰

**é‡Œç¨‹ç¢‘**ï¼šäº‹ä»¶è¿›å…¥å¼•æ“ â†’ è§„åˆ™å‘½ä¸­ â†’ å‘Šè­¦è¾“å‡º

---

### Phase 1ï¼šWasm è¿è¡Œæ—¶ + Host API v1ï¼ˆ4â€“7 äººå‘¨ï¼‰
- é›†æˆ Wasmtimeï¼ˆAOT ç¼“å­˜ã€å®ä¾‹æ± ï¼‰
- Host API v1ï¼ˆevent_getã€regex/globã€alert_emitï¼‰
- è§„åˆ™åŒ…æ ¼å¼ï¼ˆmanifest + wasm + metadataï¼‰

**é‡Œç¨‹ç¢‘**ï¼šWasm è°“è¯è§„åˆ™å¯çƒ­åŠ è½½ï¼Œç¨³å®šè·‘åœ¨ 1k EPS

---

### Phase 2ï¼šLuaJIT è¿è¡Œæ—¶å¹¶è¡Œæ¥å…¥ï¼ˆ3â€“6 äººå‘¨ï¼‰
- LuaJIT Runtimeï¼ˆFFI å‡½æ•°è¡¨ç»‘å®š Host API v1ï¼‰
- ä¸ Wasm åŒä¸€ Predicate ABIã€åŒä¸€ captures/å‘Šè­¦ç»“æ„
- åŸºå‡†æµ‹è¯•ï¼šLuaJIT vs Wasm hostcall å¼€é”€ã€ååã€å»¶è¿Ÿ

**é‡Œç¨‹ç¢‘**ï¼šåŒä¸€æ¡è§„åˆ™å¯ç”¨ Lua æˆ– Wasm åç«¯æ‰§è¡Œï¼Œç»“æœä¸€è‡´

---

### Phase 3ï¼šEQL ç¼–è¯‘å™¨ï¼ˆeqlcï¼‰+ IR + å…¼å®¹æ€§åŸºçº¿ï¼ˆ8â€“12 äººå‘¨ï¼‰
- EQL parserï¼ˆclean-roomï¼‰
- è¯­ä¹‰/ç±»å‹è§„åˆ™ï¼ˆç¼ºå¤±å­—æ®µã€å­—ç¬¦ä¸²åŒ¹é…ã€æ•°å€¼æ¯”è¾ƒï¼‰
- IRï¼šè°“è¯ DAG + åºåˆ—æ­¥éª¤æè¿°
- è¾“å‡ºåç«¯ï¼šIR â†’ Wasm predicateï¼ˆé»˜è®¤ï¼‰ï¼Œå¯é€‰ IR â†’ Lua
- **æµ‹è¯•åŸºçº¿**ï¼šè¯­æ³•/è¯­ä¹‰/è¾¹ç•Œç”¨ä¾‹ï¼ˆè¿™æ˜¯æ ¸å¿ƒèµ„äº§ï¼‰

**é‡Œç¨‹ç¢‘**ï¼šEQLï¼ˆå¿…é¡»å…¼å®¹å­é›†ï¼‰å¯ç¼–è¯‘å¹¶åœ¨å¼•æ“è¿è¡Œï¼Œæµ‹è¯•å¯¹é½

---

### Phase 4ï¼šHost NFA åºåˆ—å¼•æ“ + StateStoreï¼ˆ8â€“14 äººå‘¨ï¼‰
- NFA/partial match å¼•æ“
- maxspan/until/by è¯­ä¹‰å®ç°
- StateStoreï¼šåˆ†ç‰‡ã€TTLã€é…é¢ã€LRU
- å¯è§‚æµ‹æ€§ï¼šæ¯è§„åˆ™çŠ¶æ€è§„æ¨¡ã€æ·˜æ±°åŸå› ã€å‘½ä¸­è·¯å¾„

**é‡Œç¨‹ç¢‘**ï¼šEQL sequence åœ¨ 1k EPS ç¨³å®šï¼Œå†…å­˜å¯æ§ï¼Œç¦»çº¿å›æ”¾ä¸€è‡´

---

### Phase 5ï¼šLinux eBPF é‡‡é›† +ï¼ˆè§‚æµ‹ï¼‰ç¨³å®šåŒ–ï¼ˆ6â€“10 äººå‘¨ï¼‰
- Aya + CO-REï¼ˆå°½é‡é™ä½å†…æ ¸ç‰ˆæœ¬é€‚é…æˆæœ¬ï¼‰
- äº‹ä»¶è§„èŒƒåŒ–ï¼ˆè¿›ç¨‹æ ‘/è·¯å¾„/ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰
- è§„åˆ™å…´è¶£ä¸‹æ¨ï¼šäº‹ä»¶ç±»å‹è¿‡æ»¤ã€å…³é”®å­—æ®µè¿‡æ»¤ï¼ˆè½»é‡ï¼‰

**é‡Œç¨‹ç¢‘**ï¼šç«¯ä¾§ä½åŠŸè€—é‡‡é›† + æ£€æµ‹é—­ç¯ï¼ŒCPU å ç”¨å¯æ§

---

### Phase 6ï¼šå®æ—¶é˜»æ–­ï¼ˆEnforceï¼‰ç¬¬ä¸€ç‰ˆï¼ˆ8â€“16 äººå‘¨ï¼‰
- é€‰å®šé˜»æ–­ç‚¹ä¼˜å…ˆçº§ï¼šexec/file/networkï¼ˆå…ˆæ˜“åéš¾ï¼‰
- Inline Guard å­é›†ï¼ˆä¸¥æ ¼é¢„ç®—ã€è§„åˆ™æ ‡æ³¨å¯é˜»æ–­ï¼‰
- Actionsï¼šblock/deny/kill/quarantineï¼ˆæŒ‰å¹³å°èƒ½åŠ›ï¼‰
- å®¡è®¡é—­ç¯ï¼šæ¯æ¬¡é˜»æ–­å†³ç­–å¯è¿½æº¯

**é‡Œç¨‹ç¢‘**ï¼šå…³é”®åŠ¨ä½œå¯é˜»æ–­ï¼›è¯¯æ€å¯å›æ»šï¼›æ€§èƒ½ä¸å´©

---

### Phase 7ï¼šç¦»çº¿å®Œå…¨å¯å¤ç°ï¼ˆ4â€“8 äººå‘¨ï¼‰
- äºŒè¿›åˆ¶æ—¥å¿—æ ¼å¼ + å†™å…¥/ç´¢å¼•
- Offline replay source + ç¡®å®šæ€§æ’åº
- å›æ”¾ç»“æœä¸€è‡´æ€§æµ‹è¯•ï¼ˆè·¨æœºå™¨/è·¨æ—¶é—´ï¼‰

**é‡Œç¨‹ç¢‘**ï¼šåŒä¸€æ—¥å¿—+è§„åˆ™â†’100%ä¸€è‡´å‘Šè­¦ä¸è¯æ®

---

### æ€»ä½“ç²—ä¼°ï¼ˆåˆ° v1.0ï¼‰
- **æ ¸å¿ƒèƒ½åŠ›å¯ç”¨ï¼ˆåœ¨çº¿æ£€æµ‹ + EQL åºåˆ— + Wasm/Lua + é‡‡é›†ï¼‰**ï¼šçº¦ **32â€“54 äººå‘¨**
- **åŠ ä¸Šå®æ—¶é˜»æ–­ä¸ç¦»çº¿å®Œå…¨å¯å¤ç°**ï¼šçº¦ **48â€“78 äººå‘¨**
- ä»¥ 4 äººå›¢é˜Ÿè®¡ç®—ï¼šçº¦ **3â€“5 ä¸ªæœˆåˆ°å¯ç”¨ v0.9**ï¼Œ**5â€“8 ä¸ªæœˆåˆ°è¾ƒå®Œæ•´ v1.0**ï¼ˆå–å†³äºé˜»æ–­æ·±åº¦ä¸å¹³å°é€‚é…å¤æ‚åº¦ï¼‰

---

## 13. v0.2 çš„â€œçœ‹èµ·æ¥å°±å¾ˆä¸“ä¸šâ€çš„å»ºè®®äº¤ä»˜ç‰©æ¸…å•
1. **EQL å…¼å®¹æ€§è§„èŒƒæ–‡æ¡£**ï¼ˆæœ¬ç™½çš®ä¹¦çŸ©é˜µ â†’ å¯æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹é›†ï¼‰
2. **Host API v1 è§„èŒƒ**ï¼ˆWIT/å¤´æ–‡ä»¶ + ç‰ˆæœ¬åŒ–ç­–ç•¥ + capabilityï¼‰
3. **æ€§èƒ½åŸºçº¿æŠ¥å‘Š**ï¼ˆ1k EPSï¼šCPUã€P99 å»¶è¿Ÿã€å†…å­˜ã€åŠŸè€—è¶‹åŠ¿ï¼‰
4. **å¯å¤ç°æ€§è¯æ˜**ï¼ˆç¦»çº¿å›æ”¾ä¸€è‡´æ€§æµ‹è¯•æŠ¥å‘Šï¼‰
5. **é˜»æ–­ç‚¹èƒ½åŠ›çŸ©é˜µ**ï¼ˆä¸åŒå†…æ ¸ç‰ˆæœ¬/å‘è¡Œç‰ˆ/harmony èƒ½åŠ›å·®å¼‚è¡¨ï¼‰

---


- **é»˜è®¤ v1ï¼šå•ç§Ÿæˆ·**ï¼ˆä¸€ä¸ªè§„åˆ™é›†ï¼ˆå¤šä¸ªè§„åˆ™ï¼‰ + ä¸€ä¸ªç­–ç•¥é…ç½®ï¼‰
- ä½†æ¶æ„ä¸Šæ”¯æŒå¤š policyï¼šRuleManager æ”¯æŒåŠ è½½å¤šä¸ª rule-setï¼ˆå¦‚ `enterprise/`, `local/`ï¼‰å¹¶æŒ‰ä¼˜å…ˆçº§åˆå¹¶/å†²çªè§£å†³ï¼ˆä¾‹å¦‚åŒä¸€ rule_id ä»¥æ›´é«˜ä¼˜å…ˆçº§è¦†ç›–ï¼‰

---

## 14. C FFI å…¼å®¹æ¥å£ï¼ˆC Compatible Library Interfaceï¼‰

### 14.1 ç›®æ ‡ä¸ä»·å€¼

Kestrel æ ¸å¿ƒå¼•æ“ç”¨ Rust å®ç°ï¼Œä¸ºäº†æ”¯æŒä¸å…¶ä»– C/C++ é¡¹ç›®é›†æˆï¼ˆå¦‚ç°æœ‰çš„å®‰å…¨äº§å“ã€ç«¯ç‚¹é˜²æŠ¤ç³»ç»Ÿç­‰ï¼‰ï¼Œéœ€è¦æä¾›ç¨³å®šçš„ C å…¼å®¹æ¥å£ã€‚

**åº”ç”¨åœºæ™¯**ï¼š
- ç°æœ‰ C/C++ å®‰å…¨äº§å“é›†æˆ Kestrel æ£€æµ‹èƒ½åŠ›
- åµŒå…¥å¼ç³»ç»Ÿï¼ˆä¸æ”¯æŒ Rust è¿è¡Œæ—¶ï¼‰
- ä¸å…¶ä»–å‚å•†çš„è”åŠ¨å“åº”ï¼ˆé€šè¿‡å…±äº«åº“ï¼‰
- Python/Go/Java ç­‰è¯­è¨€é€šè¿‡ FFI è°ƒç”¨

### 14.2 è®¾è®¡åŸåˆ™

1. **ABI ç¨³å®šæ€§ä¼˜å…ˆ**ï¼šC API å¿…é¡»ä¿æŒå‘åå…¼å®¹
2. **é›¶æ‹·è´æˆ–æœ€å°æ‹·è´**ï¼šæ€§èƒ½å…³é”®è·¯å¾„é¿å…ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶
3. **é”™è¯¯å¤„ç†é€æ˜**ï¼šæ‰€æœ‰é”™è¯¯é€šè¿‡è¿”å›ç å’Œé”™è¯¯æ¶ˆæ¯ä¼ é€’
4. **èµ„æºç®¡ç†æ˜ç¡®**ï¼šæä¾›æ˜¾å¼çš„åˆ›å»º/é”€æ¯å‡½æ•°
5. **çº¿ç¨‹å®‰å…¨**ï¼šæ‰€æœ‰ API å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„

### 14.3 æ ¸å¿ƒæ¥å£è®¾è®¡

#### 14.3.1 ç±»å‹å®šä¹‰ï¼ˆkestrel_ffi.hï¼‰

```c
#include <stdint.h>
#include <stdbool.h>

// ç‰ˆæœ¬ä¿¡æ¯
#define KESTREL_VERSION_MAJOR 0
#define KESTREL_VERSION_MINOR 2
#define KESTREL_VERSION_PATCH 0

// é”™è¯¯ç 
typedef enum {
    KESTREL_OK = 0,
    KESTREL_ERROR_UNKNOWN = -1,
    KESTREL_ERROR_INVALID_ARG = -2,
    KESTREL_ERROR_NOMEM = -3,
    KESTREL_ERROR_NOT_FOUND = -4,
    KESTREL_ERROR_ALREADY_EXISTS = -5,
    KESTREL_ERROR_PARSE = -6,
    KESTREL_ERROR_RUNTIME = -7,
} kestrel_error_t;

// ä¸é€æ˜å¥æŸ„ç±»å‹ï¼ˆå‘å‰å£°æ˜ï¼‰
typedef struct kestrel_engine kestrel_engine_t;
typedef struct kestrel_event kestrel_event_t;
typedef struct kestrel_rule kestrel_rule_t;
typedef struct kestrel_alert kestrel_alert_t;
typedef struct kestrel_metrics kestrel_metrics_t;

// é…ç½®ç»“æ„
typedef struct {
    uint32_t event_bus_size;
    uint32_t worker_threads;
    uint32_t batch_size;
    bool enable_metrics;
    bool enable_tracing;
} kestrel_config_t;

// äº‹ä»¶ç»“æ„
typedef struct {
    uint64_t event_id;
    uint16_t event_type;
    uint64_t ts_mono_ns;
    uint64_t ts_wall_ns;
    uint128_t entity_key;
    uint32_t field_count;
    kestrel_field_t* fields;
} kestrel_event_t;

typedef struct {
    uint32_t field_id;
    kestrel_value_t value;
} kestrel_field_t;

typedef union {
    int64_t i64;
    uint64_t u64;
    double f64;
    bool boolean;
    struct {
        const char* data;
        size_t len;
    } string;
    struct {
        const uint8_t* data;
        size_t len;
    } bytes;
} kestrel_value_t;
```

#### 14.3.2 æ ¸å¿ƒå¼•æ“ API

```c
// å¼•æ“ç”Ÿå‘½å‘¨æœŸ
kestrel_error_t kestrel_engine_new(
    const kestrel_config_t* config,
    kestrel_engine_t** out_engine
);

void kestrel_engine_free(kestrel_engine_t* engine);

// è§„åˆ™ç®¡ç†
kestrel_error_t kestrel_engine_load_rule(
    kestrel_engine_t* engine,
    const char* rule_id,
    const char* rule_definition,
    const char** error_msg
);

kestrel_error_t kestrel_engine_unload_rule(
    kestrel_engine_t* engine,
    const char* rule_id
);

kestrel_error_t kestrel_engine_unload_all_rules(
    kestrel_engine_t* engine
);

// äº‹ä»¶å¤„ç†
kestrel_error_t kestrel_engine_process_event(
    kestrel_engine_t* engine,
    const kestrel_event_t* event,
    kestrel_alert_t*** out_alerts,
    size_t* out_alert_count
);

void kestrel_alerts_free(
    kestrel_alert_t** alerts,
    size_t count
);

// æŸ¥è¯¢å‘Šè­¦ä¿¡æ¯
const char* kestrel_alert_get_rule_id(
    const kestrel_alert_t* alert
);

uint64_t kestrel_alert_get_timestamp_ns(
    const kestrel_alert_t* alert
);

const char* kestrel_alert_get_severity(
    const kestrel_alert_t* alert
);

// Metrics
kestrel_error_t kestrel_engine_get_metrics(
    kestrel_engine_t* engine,
    kestrel_metrics_t** out_metrics
);

uint64_t kestrel_metrics_get_events_processed(
    const kestrel_metrics_t* metrics
);

uint64_t kestrel_metrics_get_alerts_generated(
    const kestrel_metrics_t* metrics
);

void kestrel_metrics_free(kestrel_metrics_t* metrics);

// ç‰ˆæœ¬ä¿¡æ¯
const char* kestrel_version(void);
```

### 14.4 å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     C/C++ Application              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ libkestrel.so / kestrel.lib
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     C FFI Layer (kestrel-ffi)       â”‚
â”‚  - C ABI wrappers                   â”‚
â”‚  - Memory management                â”‚
â”‚  - Error translation                â”‚
â”‚  - Type conversions                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Kestrel Core (Rust)             â”‚
â”‚  - Engine                           â”‚
â”‚  - NFA                              â”‚
â”‚  - Runtimes (Wasm/Lua)              â”‚
â”‚  - EventBus                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.5 å†…å­˜ç®¡ç†ç­–ç•¥

1. **è¾“å‡ºå†…å­˜ç”±è°ƒç”¨è€…é‡Šæ”¾**ï¼šæ‰€æœ‰è¿”å›çš„æŒ‡é’ˆï¼ˆalertsã€metrics ç­‰ï¼‰å¿…é¡»ç”±è°ƒç”¨è€…é€šè¿‡å¯¹åº”çš„ `_free()` å‡½æ•°é‡Šæ”¾
2. **è¾“å…¥å†…å­˜å€Ÿç”¨**ï¼šå¼•æ“ä¸æŒæœ‰è¾“å…¥äº‹ä»¶å’Œè§„åˆ™çš„å†…å­˜
3. **å…¨å±€é”ä¿æŠ¤**ï¼šæ‰€æœ‰ API å†…éƒ¨ä½¿ç”¨ mutex ä¿è¯çº¿ç¨‹å®‰å…¨

### 14.6 æ„å»ºä¸æ‰“åŒ…

#### 14.6.1 ç›®å½•ç»“æ„
```
kestrel-ffi/
â”œâ”€â”€ include/
â”‚   â””â”€â”€ kestrel.h          # å…¬å¼€ C å¤´æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs             # FFI å®ç°
â”‚   â”œâ”€â”€ engine.rs          # Engine API
â”‚   â”œâ”€â”€ events.rs          # Event API
â”‚   â”œâ”€â”€ rules.rs           # Rule API
â”‚   â””â”€â”€ metrics.rs         # Metrics API
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ c_integration/      # C é›†æˆæµ‹è¯•
â”‚       â”œâ”€â”€ test_basic.c
â”‚       â””â”€â”€ Makefile
â””â”€â”€ Cargo.toml
```

#### 14.6.2 æ„å»ºäº§ç‰©

```bash
# Linux
cargo build --release --lib -p kestrel-ffi
# ç”Ÿæˆ: target/release/libkestrel.so

# macOS
cargo build --release --lib -p kestrel-ffi
# ç”Ÿæˆ: target/release/libkestrel.dylib

# Windows (MSVC)
cargo build --release --lib -p kestrel-ffi
# ç”Ÿæˆ: target/release/kestrel.dll

# é™æ€åº“ï¼ˆå¯é€‰ï¼‰
cargo build --release --lib -p kestrel-ffi
# ç”Ÿæˆ: target/release/libkestrel.a
```

### 14.7 ä½¿ç”¨ç¤ºä¾‹

#### 14.7.1 C ç¤ºä¾‹ä»£ç 

```c
#include "kestrel.h"
#include <stdio.h>
#include <stdlib.h>

int main() {
    kestrel_engine_t* engine = NULL;
    kestrel_config_t config = {
        .event_bus_size = 10000,
        .worker_threads = 4,
        .batch_size = 100,
        .enable_metrics = true,
        .enable_tracing = false,
    };

    // åˆ›å»ºå¼•æ“
    kestrel_error_t err = kestrel_engine_new(&config, &engine);
    if (err != KESTREL_OK) {
        fprintf(stderr, "Failed to create engine\n");
        return 1;
    }

    // åŠ è½½è§„åˆ™
    const char* rule = "sequence where process.name == 'bash'";
    const char* error_msg = NULL;
    err = kestrel_engine_load_rule(engine, "rule-1", rule, &error_msg);
    if (err != KESTREL_OK) {
        fprintf(stderr, "Failed to load rule: %s\n", error_msg);
    }

    // å¤„ç†äº‹ä»¶
    kestrel_event_t event = {
        .event_id = 1,
        .event_type = 1,  // PROCESS_EXEC
        .ts_mono_ns = 1000000,
        .ts_wall_ns = 1000000,
        .entity_key = 12345,
        .field_count = 2,
        // ... fields
    };

    kestrel_alert_t** alerts = NULL;
    size_t alert_count = 0;
    err = kestrel_engine_process_event(engine, &event, &alerts, &alert_count);

    if (alert_count > 0) {
        printf("Generated %zu alerts\n", alert_count);
        for (size_t i = 0; i < alert_count; i++) {
            printf("Alert: %s\n", kestrel_alert_get_rule_id(alerts[i]));
        }
        kestrel_alerts_free(alerts, alert_count);
    }

    // æ¸…ç†
    kestrel_engine_free(engine);
    return 0;
}
```

#### 14.7.2 Python é›†æˆç¤ºä¾‹ï¼ˆé€šè¿‡ ctypes/cffiï¼‰

```python
import ctypes
from ctypes import *

# åŠ è½½å…±äº«åº“
lib = ctypes.CDLL("./libkestrel.so")

# å®šä¹‰ç±»å‹å’Œå‡½æ•°ç­¾å
lib.kestrel_engine_new.restype = c_int32
lib.kestrel_engine_new.argtypes = [POINTER(kestrel_config), POINTER(c_void_p)]

lib.kestrel_engine_process_event.restype = c_int32
lib.kestrel_engine_process_event.argtypes = [c_void_p, POINTER(kestrel_event), POINTER(c_void_p), POINTER(c_size_t)]

# ä½¿ç”¨...
engine = c_void_p()
lib.kestrel_engine_new(byref(config), byref(engine))
```

### 14.8 Phase è§„åˆ’

#### Phase 1: æ ¸å¿ƒ FFI æ¡†æ¶ï¼ˆ2-3 äººå‘¨ï¼‰
- åˆ›å»º kestrel-ffi crate
- å®ç° Engine API wrapper
- å®ç° Event/Alert API wrapper
- C å¤´æ–‡ä»¶å®šä¹‰ï¼ˆkestrel.hï¼‰
- åŸºç¡€å†…å­˜ç®¡ç†

#### Phase 2: è§„åˆ™ä¸ Metrics APIï¼ˆ2-3 äººå‘¨ï¼‰
- è§„åˆ™åŠ è½½/å¸è½½ API
- Metrics æŸ¥è¯¢ API
- é”™è¯¯æ¶ˆæ¯å¤„ç†
- èµ„æºæ¸…ç† API

#### Phase 3: æµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ2-3 äººå‘¨ï¼‰
- C é›†æˆæµ‹è¯•å¥—ä»¶
- Python bindings ç¤ºä¾‹
- ä½¿ç”¨æ–‡æ¡£ä¸ç¤ºä¾‹ä»£ç 
- æ€§èƒ½åŸºå‡†æµ‹è¯•

#### Phase 4: å¤šè¯­è¨€æ”¯æŒï¼ˆ1-2 äººå‘¨ï¼‰
- Go cgo ç»‘å®šç¤ºä¾‹
- Java JNI ç»‘å®šç¤ºä¾‹
- Node.js FFI ç¤ºä¾‹

### 14.9 å…¼å®¹æ€§ç›®æ ‡

| å¹³å° | æœ€ä½ç‰ˆæœ¬ | çŠ¶æ€ |
|------|---------|------|
| Linux glibc | 2.17 | å¾…å®ç° |
| macOS | 10.14+ | å¾…å®ç° |
| Windows | MSVC 2019+ | å¾…å®ç° |

### 14.10 è´¨é‡é—¨æ§¨

1. **ABI ç¨³å®šæ€§æµ‹è¯•**ï¼šè·¨ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•
2. **å†…å­˜æ³„æ¼æ£€æµ‹**ï¼šValgrind/Sanitizer æ£€æŸ¥
3. **çº¿ç¨‹å®‰å…¨æµ‹è¯•**ï¼šå¤šçº¿ç¨‹å¹¶å‘è°ƒç”¨æµ‹è¯•
4. **æ€§èƒ½æµ‹è¯•**ï¼šFFI å±‚å¼€é”€ < 5% æ€»å»¶è¿Ÿ
5. **æ–‡æ¡£å®Œæ•´æ€§**ï¼šæ¯ä¸ª API éƒ½æœ‰ç¤ºä¾‹ä»£ç 

### æ€»ä½“ç²—ä¼°
- **æœ€å°å¯ç”¨ç‰ˆæœ¬**ï¼ˆæ ¸å¿ƒ API + æµ‹è¯•ï¼‰ï¼šçº¦ **6â€“9 äººå‘¨**
- **å®Œæ•´ç”Ÿæ€**ï¼ˆå¤šè¯­è¨€ç»‘å®š + æ–‡æ¡£ï¼‰ï¼šçº¦ **9â€“14 äººå‘¨**
