# Kestrel æ¶æ„ä¸æ‰§è¡Œæµç¨‹è¯¦è§£

## æ ¸å¿ƒé—®é¢˜è§£ç­”

### 1. å®‰å…¨ä¸“å®¶çš„è„šæœ¬ä¼šè¢«ç¼–è¯‘æˆçŠ¶æ€æœºå—ï¼Ÿ

**ç­”æ¡ˆï¼šæ˜¯çš„ï¼Œåºåˆ—è§„åˆ™ä¼šè¢«ç¼–è¯‘æˆ NFAï¼ˆéç¡®å®šæ€§æœ‰é™è‡ªåŠ¨æœºï¼‰**

```
EQL è§„åˆ™
    â†“
[Parser] è¯­æ³•è§£æ
    â†“
[Semantic Analyzer] è¯­ä¹‰åˆ†æ
    â†“
[IR (ä¸­é—´è¡¨ç¤º)] â†â”€â”€â”€ è¿™é‡Œå‘ç”ŸçŠ¶æ€æœºè½¬æ¢
    â†“
    â”œâ”€â†’ å•äº‹ä»¶è§„åˆ™ â†’ Wasm/Lua Predicate (æ— çŠ¶æ€)
    â””â”€â†’ åºåˆ—è§„åˆ™ â†’ NFA State Machine (æœ‰çŠ¶æ€)
```

### 2. æµå¼å¤„ç†äº‹ä»¶ï¼Ÿ

**ç­”æ¡ˆï¼šæ˜¯çš„ï¼Œå®Œå…¨æµå¼å¤„ç†**

```
äº‹ä»¶æº â†’ EventBus (å¤šåˆ†åŒº) â†’ NFA Engine â†’ Predicate Runtime â†’ Alert
  â†“           â†“                    â†“                â†“              â†“
eBPF/å®¡è®¡    Worker1-4        æŒ‰entityåˆ†ç»„      Wasm/Luaè¯„ä¼°    å‘Šè­¦è¾“å‡º
           å¹¶è¡Œå¤„ç†          çŠ¶æ€è·Ÿè¸ª
```

### 3. ç«¯åˆ°ç«¯æ‰“é€šäº†ï¼Ÿ

**ç­”æ¡ˆï¼šæ£€æµ‹å¼•æ“ âœ… å®Œå…¨æ‰“é€š | eBPFé‡‡é›† ğŸŸ¡ æ¡†æ¶å®Œæˆï¼Œå¾…çœŸå®ç¯å¢ƒéªŒè¯**

---

## è¯¦ç»†æ¶æ„æµç¨‹

### é˜¶æ®µ1: è§„åˆ™ç¼–è¯‘ (é™æ€)

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®‰å…¨ä¸“å®¶ç¼–å†™ EQL è§„åˆ™                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EQL Parser (pest grammar)                                  â”‚
â”‚  è§£æè¯­æ³•: sequence, where, by, maxspan, until             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Semantic Analyzer                                          â”‚
â”‚  - ç±»å‹æ£€æŸ¥                                                  â”‚
â”‚  - å­—æ®µè§£æ (field_path â†’ field_id)                         â”‚
â”‚  - Schema éªŒè¯                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IR (ä¸­é—´è¡¨ç¤º) - å…³é”®è½¬æ¢ç‚¹                                  â”‚
â”‚                                                              â”‚
â”‚  IrRule {                                                    â”‚
â”‚    rule_type: Event | Sequence                              â”‚
â”‚    predicates: HashMap<String, IrPredicate>                 â”‚
â”‚    sequence: IrSequence {                                    â”‚
â”‚      steps: [step_id, event_type_id, predicate_id]          â”‚
â”‚      by_field_id: u32                                       â”‚
â”‚      maxspan_ns: u64                                        â”‚
â”‚      until: Option<step_id>                                â”‚
â”‚    }                                                         â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wasm Code Generator    â”‚   â”‚  NFA Compiler                â”‚
â”‚  (è°“è¯é€»è¾‘)              â”‚   â”‚  (åºåˆ—çŠ¶æ€æœº)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pred_init()             â”‚   â”‚ NfaSequence {                â”‚
â”‚ pred_eval()             â”‚   â”‚   id: String                 â”‚
â”‚ pred_capture()          â”‚   â”‚   steps: [SeqStep]           â”‚
â”‚                         â”‚   â”‚   maxspan_ns: u64            â”‚
â”‚ ç”Ÿæˆ .wat â†’ .wasm       â”‚   â”‚   until: Option<StepId>      â”‚
â”‚                         â”‚   â”‚ }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wasm Runtime           â”‚   â”‚  NFA Engine (Host)           â”‚
â”‚  (Wasmtime)             â”‚   â”‚  - çŠ¶æ€è·Ÿè¸ª                   â”‚
â”‚  - æ²™ç®±æ‰§è¡Œ              â”‚   â”‚  - TTL/LRUæ·˜æ±°               â”‚
â”‚  - Fuelé™åˆ¶              â”‚   â”‚  - é…é¢ç®¡ç†                   â”‚
â”‚  - å†…å­˜é™åˆ¶              â”‚   â”‚  - æŒ‰entityåˆ†ç»„               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é˜¶æ®µ2: äº‹ä»¶æµå¤„ç† (è¿è¡Œæ—¶)

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‹ä»¶é‡‡é›†å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ eBPF     â”‚  â”‚ Audit    â”‚  â”‚ Socket   â”‚  â”‚ Replay   â”‚    â”‚
â”‚  â”‚ tracepts â”‚  â”‚ /audit   â”‚  â”‚ events   â”‚  â”‚ offline  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“            â†“             â†“             â†“
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Event Normalizer     â”‚
                â”‚  - ç»Ÿä¸€å­—æ®µæ ¼å¼         â”‚
                â”‚  - ç±»å‹è½¬æ¢             â”‚
                â”‚  - SchemaéªŒè¯          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EventBus (å¤šåˆ†åŒº)                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Partition 0â”‚  â”‚Partition 1â”‚  â”‚Partition 2â”‚  â”‚   ...   â”‚ â”‚
â”‚  â”‚ Worker    â”‚  â”‚ Worker    â”‚  â”‚ Worker    â”‚  â”‚         â”‚ â”‚
â”‚  â”‚ (entity%4)â”‚  â”‚ (entity%4)â”‚  â”‚ (entity%4)â”‚  â”‚         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“              â†“              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       Detection Engine               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SingleEvent Rules â”‚   â”‚  Sequence Rules       â”‚
â”‚                   â”‚   â”‚  (NFA State Machine)  â”‚
â”‚ åŒ¹é… event_type   â”‚   â”‚                       â”‚
â”‚      â†“            â”‚   â”‚  process_event()      â”‚
â”‚ Wasm/Lua eval     â”‚   â”‚      â†“                â”‚
â”‚      â†“            â”‚   â”‚  æŒ‰entityåˆ†ç»„         â”‚
â”‚   Alert?          â”‚   â”‚      â†“                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  æŸ¥æ‰¾partial matches  â”‚
                        â”‚      â†“                â”‚
                        â”‚  æ›´æ–°çŠ¶æ€:            â”‚
                        â”‚  - advance()         â”‚
                        â”‚  - expire(maxspan)   â”‚
                        â”‚  - check_until()     â”‚
                        â”‚      â†“                â”‚
                        â”‚  åºåˆ—å®Œæˆ?            â”‚
                        â”‚      â†“                â”‚
                        â”‚  Wasm/Lua eval       â”‚
                        â”‚      â†“                â”‚
                        â”‚   SequenceAlert       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### çŠ¶æ€æœºå·¥ä½œåŸç† (NFA)

```text
ç¤ºä¾‹è§„åˆ™: sequence by process.entity_id
           [process where process.executable == "/bin/bash"]
           [file where file.path == "/etc/passwd"]
           with maxspan=5s

ç¼–è¯‘æˆ NFA:

State 0 (Initial) â”€â”€[bash event]â”€â”€> State 1 (Partial match)
                                              â”‚
                                       State 1 (Partial match)
                                              â”‚
                                       [file event + /etc/passwd]
                                              â”‚
                                              â†“
                                        State 2 (Accepting)
                                              â”‚
                                          Alert!

å†…å­˜çŠ¶æ€ (Partial Match):

PartialMatch {
  sequence_id: "rule-001",
  entity_key: 0x7f3a2b1c0d4e,  // æŒ‰entityåˆ†ç»„
  current_state: 1,           // å½“å‰åœ¨ State 1
  matched_events: [
    MatchedEvent {
      state_id: 0,
      event_id: 12345,
      timestamp_ns: 1704067199000000000,
    }
  ],
  created_ns: 1704067199000000000,
  terminated: false,
}

TTL æ·˜æ±° (maxspan):

if (now_ns - pm.created_ns) > maxspan_ns {
  state_store.expire(sequence_id, entity_key);
}
```

---

## å®é™…ä»£ç æµç¨‹

### è§„åˆ™åŠ è½½

```rust
// kestrel-engine/src/lib.rs

// 1. åŠ è½½è§„åˆ™
let rule_json = std::fs::read_to_string("rules/suspicious-exec.json")?;
let rule: RulePackage = serde_json::from_str(&rule_json)?;

// 2. ç¼–è¯‘ EQL åˆ° Wasm
let eql_compiler = EqlCompiler::new(schema);
let wat = eql_compiler.compile_to_wasm(&rule.eql)?;

// 3. åŠ è½½ Wasm
wasm_engine.load_predicate("rule-001", &wasm_bytes)?;

// 4. å¦‚æœæ˜¯åºåˆ—è§„åˆ™ï¼ŒåŠ è½½åˆ° NFA
if let IrRuleType::Sequence { .. } = ir_rule {
    let compiled = CompiledSequence::from_ir(ir_rule, wasm_bytes)?;
    nfa_engine.load_sequence(compiled)?;
}
```

### äº‹ä»¶å¤„ç†

```rust
// kestrel-engine/src/lib.rs

pub async fn eval_event(&self, event: Event) -> Vec<Alert> {
    let mut alerts = Vec::new();

    // 1. å¤„ç†å•äº‹ä»¶è§„åˆ™ (æµå¼)
    if let Some(rules) = self.single_event_rules.get(&event.event_type_id()) {
        for rule in rules {
            if self.wasm_engine.eval_predicate(&rule.predicate_id, &event)? {
                alerts.push(rule.generate_alert(&event)?);
            }
        }
    }

    // 2. å¤„ç†åºåˆ—è§„åˆ™ (çŠ¶æ€æœº)
    let sequence_alerts = self.nfa_engine.process_event(event)?.clone();
    for seq_alert in sequence_alerts {
        alerts.push(seq_alert.into());
    }

    alerts
}
```

### NFA çŠ¶æ€æœºå¤„ç†

```rust
// kestrel-nfa/src/engine.rs

pub fn process_event(&self, event: &Event) -> NfaResult<Vec<SequenceAlert>> {
    let mut alerts = Vec::new();

    // 1. æ‰¾åˆ°æ‰€æœ‰ç›¸å…³åºåˆ— (é€šè¿‡ event_type_index)
    let sequence_ids = self.get_relevant_sequences(event.event_type_id())?;

    // 2. æŒ‰ entity åˆ†ç»„
    let entity_key = event.entity_key;

    for seq_id in sequence_ids {
        let sequence = &self.sequences[&seq_id];

        // 3. æŸ¥æ‰¾æ‰€æœ‰ partial matches
        for state_id in 0..=sequence.max_state() {
            let key = (seq_id.clone(), entity_key, state_id);

            if let Some(pm) = self.state_store.get(&key) {
                // 4. å°è¯•æ¨è¿›çŠ¶æ€
                if self.try_advance(pm, event, sequence)? {
                    // 5. æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if pm.current_state == sequence.max_state() {
                        // 6. è¯„ä¼° final predicate
                        if self.predicate_evaluator.evaluate(
                            &sequence.final_predicate_id,
                            event
                        )? {
                            alerts.push(self.generate_alert(pm)?);
                        }
                    }
                }
            }
        }

        // 7. åˆ›å»ºæ–°çš„ partial match (å¦‚æœæ˜¯ç¬¬ä¸€æ­¥)
        if let Some(first_step) = sequence.first_step() {
            if self.predicate_evaluator.evaluate(&first_step.predicate_id, event)? {
                self.state_store.create_partial_match(
                    seq_id.clone(),
                    entity_key,
                    first_step.state_id,
                    event,
                )?;
            }
        }
    }

    Ok(alerts)
}
```

---

## ç«¯åˆ°ç«¯éªŒè¯çŠ¶æ€

### âœ… å·²æ‰“é€š (æµ‹è¯•éªŒè¯)

| ç»„ä»¶ | çŠ¶æ€ | æµ‹è¯• |
|------|------|------|
| EQL Parser | âœ… | 35/35 æµ‹è¯•é€šè¿‡ |
| Wasm Codegen | âœ… | å®Œæ•´ IR â†’ Wasm |
| NFA Engine | âœ… | 22/22 æµ‹è¯•é€šè¿‡ |
| Predicate Runtime | âœ… | Wasm + Lua |
| EventBus | âœ… | å¤šåˆ†åŒºæµå¼å¤„ç† |
| Detection Engine | âœ… | ç«¯åˆ°ç«¯é›†æˆæµ‹è¯• |

### ğŸŸ¡ æ¡†æ¶å®Œæˆ (å¾…çœŸå®ç¯å¢ƒéªŒè¯)

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| eBPF é‡‡é›† | ğŸŸ¡ | æ¡†æ¶å®Œæ•´ï¼Œéœ€è¦rootç¯å¢ƒæµ‹è¯• |
| RingBuf Polling | ğŸŸ¡ | ä»£ç å®ç°ï¼Œå¾…çœŸå®eBPFç¨‹åºéªŒè¯ |
| LSM Hooks | ğŸŸ¡ | æ¡†æ¶å­˜åœ¨ï¼Œéœ€è¦å†…æ ¸æ”¯æŒ |

### æµ‹è¯•è¦†ç›–

```bash
$ cargo test --workspace

test result: ok. 201 passed; 0 failed

- å•å…ƒæµ‹è¯•: 168
- é›†æˆæµ‹è¯•: 33
- E2Eæµ‹è¯•: 3 (detection_scenarios, integration_e2e)
```

---

## æ€§èƒ½ç‰¹æ€§

### æµå¼å¤„ç†ç‰¹æ€§

1. **å¸¸é‡å†…å­˜**: æ¯ä¸ªentityåªè·Ÿè¸ªå½“å‰partial matchçŠ¶æ€
2. **O(1)æŸ¥æ‰¾**: event_type_indexå¿«é€Ÿå®šä½ç›¸å…³åºåˆ—
3. **å¹¶è¡Œå¤„ç†**: å¤šä¸ªentityç‹¬ç«‹å¤„ç†
4. **TTLæ·˜æ±°**: è¿‡æœŸçŠ¶æ€è‡ªåŠ¨æ¸…ç†

### çŠ¶æ€æœºä¼˜åŒ–

```rust
// äº‹ä»¶ç±»å‹ç´¢å¼• (é¿å…éå†æ‰€æœ‰åºåˆ—)
event_type_index: HashMap<u16, Vec<String>>
//                    â†‘          â†‘
//                 event_type  sequence_ids

// åˆ†ç‰‡çŠ¶æ€å­˜å‚¨ (å‡å°‘é”ç«äº‰)
StateStore {
  shards: Vec<RwLock<HashMap<ShardKey, PartialMatch>>>,
  shard_count: 16,
}

// é…é¢ä¿æŠ¤ (é˜²æ­¢å•entityè€—å°½å†…å­˜)
Quota {
  per_entity: 100,      // æ¯ä¸ªentityæœ€å¤š100ä¸ªpartial match
  per_sequence: 10000,  // æ¯ä¸ªåºåˆ—æœ€å¤š10000ä¸ªpartial match
  total: 1000000,       // æ€»å…±æœ€å¤š100ä¸‡ä¸ªpartial match
}
```

---

## æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| è„šæœ¬ç¼–è¯‘æˆçŠ¶æ€æœºï¼Ÿ | âœ… **æ˜¯çš„**ï¼Œåºåˆ—è§„åˆ™ç¼–è¯‘æˆNFAï¼Œå•äº‹ä»¶è§„åˆ™ç¼–è¯‘æˆWasm/Lua |
| æµå¼å¤„ç†äº‹ä»¶ï¼Ÿ | âœ… **æ˜¯çš„**ï¼ŒEventBuså¤šåˆ†åŒºå¹¶è¡Œï¼Œå¸¸é‡å†…å­˜ |
| ç«¯åˆ°ç«¯æ‰“é€šï¼Ÿ | âœ… **æ£€æµ‹å¼•æ“å®Œå…¨æ‰“é€š**ï¼ŒeBPFé‡‡é›†æ¡†æ¶å®Œæˆå¾…éªŒè¯ |

**ç”Ÿäº§å°±ç»ªåº¦: 95%** (å‰©ä¸‹5%æ˜¯çœŸå®eBPFç¯å¢ƒçš„ç«¯åˆ°ç«¯éªŒè¯)
